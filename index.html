<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tic Tac Toe Pro Ultra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap');
        
        /* Proteksi Global: Anti-Zoom, Anti-Geser, Anti-Salin */
        html, body {
            overflow: hidden;
            overscroll-behavior: none;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            touch-action: none;
            height: 100%;
            width: 100%;
            position: fixed;
            background-color: #ffffff;
        }

        input {
            user-select: text !important;
            -webkit-user-select: text !important;
            touch-action: auto !important;
        }

        body {
            font-family: 'Poppins', sans-serif;
            color: #1f1f1f;
        }

        /* Layout */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100dvh;
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
            padding: 1.25rem;
            position: relative;
        }

        /* Google Material 3 Style */
        .google-card {
            background-color: #ffffff;
            border-radius: 28px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid #f1f3f4;
        }

        .mode-tabs {
            background-color: #f1f3f4;
            border-radius: 100px;
            padding: 6px;
            display: flex;
            gap: 4px;
        }

        .mode-tab {
            padding: 10px 16px;
            border-radius: 100px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex: 1;
            text-align: center;
            color: #444746;
        }

        .mode-tab.active {
            background-color: #ffffff;
            color: #1a73e8;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .board-container {
            background-color: #f1f3f4;
            border-radius: 36px;
            padding: 12px;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.04);
            border: 1px solid #e0e0e0;
        }

        .cell {
            aspect-ratio: 1 / 1;
            background-color: #ffffff;
            border-radius: 22px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10;
            border: 1px solid #f1f3f4;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        }

        .cell:active { transform: scale(0.92); background-color: #f8f9fa; }

        .x-mark { color: #d93025; filter: drop-shadow(0 2px 6px rgba(217, 48, 37, 0.2)); }
        .o-mark { color: #1a73e8; filter: drop-shadow(0 2px 6px rgba(26, 115, 232, 0.2)); }

        #winLineOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 30;
            padding: 12px;
        }

        #winLine {
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: drawLine 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            stroke-linecap: round;
            stroke-width: 7;
        }

        @keyframes drawLine { to { stroke-dashoffset: 0; } }

        .mute-btn {
            background-color: #ffffff;
            width: 52px;
            height: 52px;
            border-radius: 18px;
            color: #444746;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            border: 1px solid #e0e0e0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        }

        .mute-btn:active { transform: scale(0.9); }

        #board.grid-3 { grid-template-columns: repeat(3, 1fr); }
        #board.grid-4 { grid-template-columns: repeat(4, 1fr); }
        #board.grid-5 { grid-template-columns: repeat(5, 1fr); }

        .loading-dots:after { content: '.'; animation: dots 1s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } 80%, 100% { content: ''; } }

        .watermark {
            text-align: center;
            font-size: 10px;
            font-weight: 700;
            color: #bdc1c6;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-top: 1rem;
            opacity: 0.8;
        }

        /* CHAT STYLES */
        #chatPanel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            z-index: 100;
            border-radius: 32px 32px 0 0;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.15);
            max-height: 80dvh;
        }
        #chatPanel.open { transform: translateY(0); }
        .chat-bubble {
            max-width: 80%;
            padding: 10px 16px;
            border-radius: 18px;
            margin-bottom: 8px;
            font-size: 13px;
            line-height: 1.4;
            word-wrap: break-word;
        }
        .chat-me { background: #1a73e8; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .chat-them { background: #f1f3f4; color: #1f1f1f; align-self: flex-start; border-bottom-left-radius: 4px; }
    </style>
</head>
<body>

    <div class="app-container">
        <!-- HEADER -->
        <div class="header-content text-center mb-6 shrink-0">
            <h1 class="text-2xl font-bold tracking-tight text-[#1f1f1f] mb-4">Tic Tac <span class="text-blue-600">Toe</span> Pro</h1>
            
            <div id="onlineRoomBadge" class="hidden mb-4">
                <div class="flex items-center justify-center gap-2">
                    <div class="inline-flex items-center gap-2 bg-[#e8f0fe] text-[#1a73e8] px-5 py-2 rounded-full border border-[#aecbfa] shadow-sm">
                        <span class="text-[10px] font-bold uppercase tracking-widest opacity-70">Room ID:</span>
                        <span id="displayRoomId" class="font-mono font-bold tracking-wider">------</span>
                        <button onclick="copyRoomId()" class="ml-1 p-1.5 rounded-full transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                        </button>
                    </div>
                    <button onclick="toggleChat()" class="relative bg-white p-2.5 rounded-full border border-gray-200 shadow-sm active:scale-90 transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                        </svg>
                        <span id="chatDot" class="absolute top-1 right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white hidden"></span>
                    </button>
                </div>
            </div>

            <!-- SCORE BOARD -->
            <div class="flex items-center gap-3">
                <div class="google-card p-3 flex-1 flex flex-col items-center transition-all border-b-4 border-transparent" id="boxX">
                    <span class="text-[9px] font-bold text-[#5f6368] uppercase tracking-tighter" id="labelX">Pemain X</span>
                    <span id="scoreX" class="text-2xl font-bold text-[#d93025]">0</span>
                </div>
                <div class="google-card p-2 px-4 shrink-0 flex flex-col items-center bg-[#f1f3f4] border border-[#e0e0e0] shadow-none">
                    <span class="text-[9px] font-bold text-[#5f6368] uppercase">Draw</span>
                    <span id="scoreDraw" class="text-xl font-bold text-[#1f1f1f]">0</span>
                </div>
                <div class="google-card p-3 flex-1 flex flex-col items-center transition-all border-b-4 border-transparent" id="boxO">
                    <span class="text-[9px] font-bold text-[#5f6368] uppercase tracking-tighter" id="labelO">Pemain O</span>
                    <span id="scoreO" class="text-2xl font-bold text-[#1a73e8]">0</span>
                </div>
            </div>
        </div>

        <div class="main-content flex flex-col">
            <!-- SETTINGS -->
            <div id="gameSettings" class="flex flex-col gap-4 mb-6">
                <div id="gridSelectorContainer" class="flex items-center justify-between">
                    <span class="text-[10px] font-bold text-[#5f6368] uppercase tracking-widest">Pilih Grid</span>
                    <div class="flex gap-2">
                        <button onclick="changeGrid(3)" id="grid3" class="px-4 py-1.5 rounded-full text-[10px] font-bold bg-[#1a73e8] text-white shadow-sm transition-all">3x3</button>
                        <button onclick="changeGrid(4)" id="grid4" class="px-4 py-1.5 rounded-full text-[10px] font-bold bg-[#ffffff] text-[#444746] border border-[#e0e0e0] shadow-sm transition-all">4x4</button>
                        <button onclick="changeGrid(5)" id="grid5" class="px-4 py-1.5 rounded-full text-[10px] font-bold bg-[#ffffff] text-[#444746] border border-[#e0e0e0] shadow-sm transition-all">5x5</button>
                    </div>
                </div>

                <div id="aiLevelContainer" class="flex items-center justify-between hidden">
                    <span class="text-[10px] font-bold text-[#5f6368] uppercase tracking-widest">Level AI</span>
                    <div class="flex gap-2">
                        <button onclick="changeDifficulty('easy')" id="diffEasy" class="px-3 py-1.5 rounded-full text-[10px] font-bold bg-[#1e8e3e] text-white transition-all uppercase shadow-sm">Easy</button>
                        <button onclick="changeDifficulty('medium')" id="diffMedium" class="px-3 py-1.5 rounded-full text-[10px] font-bold bg-[#ffffff] text-[#444746] border border-[#e0e0e0] transition-all uppercase shadow-sm">Med</button>
                        <button onclick="changeDifficulty('hard')" id="diffHard" class="px-3 py-1.5 rounded-full text-[10px] font-bold bg-[#ffffff] text-[#444746] border border-[#e0e0e0] transition-all uppercase shadow-sm">Hard</button>
                    </div>
                </div>
            </div>

            <!-- MODE TABS -->
            <div class="mode-tabs mb-6">
                <button onclick="setMode('pvp')" id="btnPvp" class="mode-tab active">Teman</button>
                <button onclick="setMode('pve')" id="btnPve" class="mode-tab">Bot AI</button>
                <button onclick="setMode('online')" id="btnOnline" class="mode-tab">Online</button>
            </div>

            <!-- LOBBY -->
            <div id="onlineLobby" class="hidden google-card p-6 mb-6 text-center">
                <h3 class="text-sm font-bold mb-4 text-[#1a73e8] tracking-wide uppercase">Multiplayer Online</h3>
                <div class="space-y-4">
                    <button onclick="createNewRoom()" class="w-full bg-[#1a73e8] hover:bg-[#174ea6] text-white font-bold py-3.5 rounded-2xl shadow-md transition-all active:scale-95">
                        Buat Room Baru
                    </button>
                    <div class="flex items-center gap-3 px-2">
                        <div class="h-[1px] bg-[#e0e0e0] flex-1"></div>
                        <span class="text-[10px] font-bold text-[#5f6368] uppercase">Atau</span>
                        <div class="h-[1px] bg-[#e0e0e0] flex-1"></div>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="roomInput" placeholder="Kode Room" class="flex-1 bg-[#f1f3f4] border border-transparent rounded-2xl px-4 py-3 text-[#1f1f1f] font-bold uppercase text-center outline-none focus:bg-white focus:border-[#1a73e8] text-xs tracking-widest transition-all">
                        <button onclick="joinRoom()" class="bg-[#1f1f1f] hover:bg-[#000000] text-white font-bold px-6 rounded-2xl transition-all text-xs">Join</button>
                    </div>
                </div>
                <p id="connectionStatus" class="mt-4 text-[9px] text-[#5f6368] font-medium uppercase tracking-widest">Server: Menghubungkan...</p>
            </div>

            <!-- BOARD CONTAINER -->
            <div class="relative mb-6">
                <div class="board-container shadow-xl">
                    <div id="board" class="grid gap-2 relative">
                        <!-- Cells -->
                    </div>
                </div>
                <svg id="winLineOverlay" viewBox="0 0 100 100" preserveAspectRatio="none">
                    <line id="winLine" x1="0" y1="0" x2="0" y2="0" stroke="white" class="hidden" />
                </svg>
            </div>

            <!-- TURN INDICATOR -->
            <div id="turnStatus" class="mb-8 text-center">
                <div class="inline-flex items-center gap-2 bg-[#ffffff] px-7 py-3 rounded-full border border-[#e0e0e0] shadow-sm">
                    <div class="w-2 h-2 rounded-full animate-pulse bg-[#d93025]" id="turnPulse"></div>
                    <span class="text-[11px] font-bold text-[#1f1f1f] uppercase tracking-widest" id="currentPlayerText">PEMAIN X</span>
                </div>
            </div>

            <!-- BOTTOM CONTROLS -->
            <div class="mt-auto flex items-center gap-4">
                <div id="controls" class="flex flex-1 gap-3">
                    <button onclick="resetGame()" class="flex-1 bg-[#1f1f1f] text-white font-bold py-4 rounded-2xl shadow-lg transition-all active:scale-95 text-xs uppercase tracking-widest">
                        Ulangi
                    </button>
                    <button onclick="resetScores()" class="bg-[#ffffff] border border-[#e0e0e0] text-[#5f6368] p-4 rounded-2xl shadow-sm transition-all active:scale-95">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
                
                <button onclick="toggleMute()" class="mute-btn shrink-0" id="muteBtn">
                    <svg id="svg-speaker" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                    </svg>
                </button>
            </div>

            <!-- WATERMARK -->
            <div class="watermark">
                BY FAUZI DEV
            </div>
        </div>

        <!-- MODAL -->
        <div id="statusModal" class="fixed inset-0 bg-[#202124]/40 backdrop-blur-sm hidden items-center justify-center z-50 p-6">
            <div class="google-card p-10 w-full max-w-xs text-center scale-90 transition-transform duration-300 shadow-2xl" id="modalContent">
                <div class="w-16 h-16 bg-[#e8f0fe] rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-[#1a73e8]" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                </div>
                <h2 id="winnerText" class="text-2xl font-extrabold mb-2 text-[#1f1f1f] uppercase">X MENANG!</h2>
                <p id="winnerSubtext" class="text-xs text-[#5f6368] mb-8 font-medium">Permainan selesai.</p>
                <button onclick="handlePlayAgain()" class="w-full bg-[#1a73e8] hover:bg-[#174ea6] text-white font-bold py-4 rounded-2xl shadow-xl transition-all active:scale-95 text-sm uppercase tracking-widest">
                    Main Lagi
                </button>
            </div>
        </div>

        <!-- CHAT PANEL -->
        <div id="chatPanel">
            <div class="flex items-center justify-between p-5 border-b shrink-0">
                <span class="font-bold text-sm text-gray-700 tracking-tight uppercase">Obrolan Room</span>
                <button onclick="toggleChat()" class="p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="chatMessages" class="flex-1 overflow-y-auto p-5 flex flex-col bg-[#fafafa]">
                <!-- Messages -->
            </div>
            <div class="p-4 border-t shrink-0 flex gap-2 items-center bg-white pb-10">
                <input type="text" id="chatInput" placeholder="Ketik pesan..." class="flex-1 bg-[#f1f3f4] rounded-2xl px-4 py-3 text-sm outline-none focus:bg-white focus:border-[#1a73e8] border border-transparent transition-all">
                <button onclick="sendChatMessage()" class="bg-[#1a73e8] text-white p-3 rounded-full shadow-md active:scale-90 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
                </button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-[#1f1f1f] text-white px-6 py-2.5 rounded-full font-bold shadow-2xl opacity-0 transition-opacity pointer-events-none z-[60] text-[10px] tracking-widest uppercase">
        Kode Disalin!
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, deleteDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- AUDIO ---
        let audioCtx = null, isMuted = false, bgmSource = null;
        const initAudio = () => { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (audioCtx.state === 'suspended') audioCtx.resume(); };
        const playSFX = (type) => {
            if (isMuted || !audioCtx) return;
            const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            if (type === 'click') { osc.type = 'sine'; osc.frequency.setValueAtTime(400, now); osc.frequency.exponentialRampToValueAtTime(10, now + 0.1); gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1); osc.start(); osc.stop(now + 0.1); }
            else if (type === 'win') { osc.type = 'triangle'; [523, 659, 783, 1046].forEach((f, i) => osc.frequency.setValueAtTime(f, now + i * 0.1)); gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5); osc.start(); osc.stop(now + 0.5); }
            else if (type === 'draw') { osc.type = 'sine'; osc.frequency.setValueAtTime(200, now); osc.frequency.linearRampToValueAtTime(100, now + 0.3); gain.gain.setValueAtTime(0.3, now); gain.gain.linearRampToValueAtTime(0.01, now + 0.3); osc.start(); osc.stop(now + 0.3); }
        };
        const startBGM = () => {
            if (isMuted || !audioCtx || bgmSource) return;
            const masterGain = audioCtx.createGain(); masterGain.gain.setValueAtTime(0.02, audioCtx.currentTime); masterGain.connect(audioCtx.destination);
            const playNote = () => {
                if (isMuted) return;
                const osc = audioCtx.createOscillator(), g = audioCtx.createGain();
                osc.connect(g); g.connect(masterGain);
                osc.frequency.setValueAtTime([261.63, 329.63, 392.00, 440.00][Math.floor(Math.random() * 4)], audioCtx.currentTime);
                g.gain.setValueAtTime(0, audioCtx.currentTime); g.gain.linearRampToValueAtTime(1, audioCtx.currentTime + 1.5); g.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 4);
                osc.start(); osc.stop(audioCtx.currentTime + 4); setTimeout(playNote, 3000);
            };
            bgmSource = true;
            playNote();
        };

        window.toggleMute = () => {
            isMuted = !isMuted; const svg = document.getElementById('svg-speaker');
            if (isMuted) svg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />';
            else { initAudio(); startBGM(); svg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />'; }
        };

        // --- GAME LOGIC ---
        let gridSize = 3, board = Array(9).fill(''), currentPlayer = 'X', gameActive = true, gameMode = 'pvp', aiDifficulty = 'easy', scores = { X: 0, O: 0, draw: 0 };
        let db, auth, userId, currentRoomId = null, mySymbol = null, unsubscribeRoom = null, unsubscribeChat = null;
        
        // --- UPDATED FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAiknTiGhLeeZREUy5CJQ6Gq8O0FSXWYh8",
            authDomain: "tictactoe-ultra.firebaseapp.com",
            projectId: "tictactoe-ultra",
            storageBucket: "tictactoe-ultra.firebasestorage.app",
            messagingSenderId: "110161757179",
            appId: "1:110161757179:web:b3aaf10a123a77728d815e"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'tictactoe-pro-google-final-v2';
        const app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app);

        const boardElement = document.getElementById('board'), scoreXElement = document.getElementById('scoreX'), scoreOElement = document.getElementById('scoreO'), scoreDrawElement = document.getElementById('scoreDraw');
        const currentPlayerText = document.getElementById('currentPlayerText'), statusModal = document.getElementById('statusModal'), winnerText = document.getElementById('winnerText'), onlineLobby = document.getElementById('onlineLobby');
        const onlineRoomBadge = document.getElementById('onlineRoomBadge'), gridSelectorContainer = document.getElementById('gridSelectorContainer'), winLine = document.getElementById('winLine'), aiLevelContainer = document.getElementById('aiLevelContainer');

        async function initAuth() { if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token); else await signInAnonymously(auth); }
        onAuthStateChanged(auth, (user) => { if (user) { userId = user.uid; const s = document.getElementById('connectionStatus'); if (s) s.innerText = "Server: Online (" + userId.substring(0,4) + ")"; } });
        initAuth();

        function checkWinCondition(cb, size) {
            const winLength = size === 3 ? 3 : 4; 
            for (let r = 0; r < size; r++) {
                for (let c = 0; c < size; c++) {
                    const p = cb[r * size + c]; if (!p) continue;
                    const checks = [[0,1], [1,0], [1,1], [1,-1]];
                    for (let [dr, dc] of checks) {
                        let win = true, line = [];
                        for (let k = 0; k < winLength; k++) {
                            const nr = r + k * dr, nc = c + k * dc;
                            if (nr < 0 || nr >= size || nc < 0 || nc >= size || cb[nr * size + nc] !== p) { win = false; break; }
                            line.push(nr * size + nc);
                        }
                        if (win) return { winner: p, line };
                    }
                }
            }
            return cb.includes('') ? null : { winner: 'draw', line: null };
        }

        function initBoard() {
            boardElement.innerHTML = ''; boardElement.className = `grid grid-${gridSize} gap-2 relative`;
            board.forEach((cell, index) => {
                const el = document.createElement('div'); el.classList.add('cell');
                if (gridSize === 3) el.classList.add('text-5xl', 'font-extrabold'); else if (gridSize === 4) el.classList.add('text-3xl', 'font-bold'); else el.classList.add('text-2xl', 'font-bold');
                el.dataset.index = index; el.addEventListener('click', handleCellClick);
                if (cell !== '') { el.innerText = cell; el.classList.add(cell === 'X' ? 'x-mark' : 'o-mark'); }
                boardElement.appendChild(el);
            });
            winLine.classList.add('hidden');
        }

        function drawWinningLine(li) {
            const s = gridSize, sIdx = li[0], eIdx = li[li.length - 1];
            const sc = sIdx % s, sr = Math.floor(sIdx / s), ec = eIdx % s, er = Math.floor(eIdx / s);
            const cs = 100 / s, os = cs / 2;
            winLine.setAttribute('x1', sc * cs + os); winLine.setAttribute('y1', sr * cs + os);
            winLine.setAttribute('x2', ec * cs + os); winLine.setAttribute('y2', er * cs + os);
            winLine.setAttribute('stroke', currentPlayer === 'X' ? '#d93025' : '#1a73e8');
            winLine.classList.remove('hidden'); winLine.style.animation = 'none'; winLine.offsetHeight; winLine.style.animation = null;
        }

        window.changeGrid = (size) => {
            initAudio(); playSFX('click'); if (currentRoomId) return alert("Selesaikan permainan online dulu.");
            gridSize = size; board = Array(size * size).fill('');
            [3, 4, 5].forEach(v => { const b = document.getElementById(`grid${v}`); b.className = (v === size) ? "px-4 py-1.5 rounded-full text-[10px] font-bold bg-[#1a73e8] text-white shadow-sm transition-all" : "px-4 py-1.5 rounded-full text-[10px] font-bold bg-[#ffffff] text-[#444746] border border-[#e0e0e0] shadow-sm transition-all"; });
            resetGame();
        };

        window.setMode = async (mode) => {
            initAudio(); playSFX('click'); startBGM();
            if (gameMode === 'online' && currentRoomId && mySymbol === 'X') { try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId)); } catch(e) {} }
            if (unsubscribeRoom) { unsubscribeRoom(); unsubscribeRoom = null; }
            if (unsubscribeChat) { unsubscribeChat(); unsubscribeChat = null; }
            resetScores(); gameMode = mode; currentRoomId = null; mySymbol = null;
            ['pvp', 'pve', 'online'].forEach(m => { const b = document.getElementById('btn' + m.charAt(0).toUpperCase() + m.slice(1)); b.className = (m === mode) ? "mode-tab active" : "mode-tab"; });
            aiLevelContainer.classList.toggle('hidden', mode !== 'pve'); onlineLobby.classList.toggle('hidden', mode !== 'online');
            boardElement.parentElement.parentElement.classList.toggle('hidden', mode === 'online'); document.getElementById('turnStatus').classList.toggle('hidden', mode === 'online');
            onlineRoomBadge.classList.add('hidden'); gridSelectorContainer.classList.remove('hidden'); 
            document.getElementById('chatPanel').classList.remove('open');
            resetGame();
        };

        async function handleCellClick(e) {
            initAudio(); const index = parseInt(e.currentTarget.dataset.index);
            if (board[index] !== '' || !gameActive) return;
            playSFX('click');
            if (gameMode === 'online') {
                if (mySymbol !== currentPlayer || !currentRoomId) return;
                const nb = [...board]; nb[index] = mySymbol; const wd = checkWinCondition(nb, gridSize);
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId), {
                    board: nb, currentPlayer: mySymbol === 'X' ? 'O' : 'X',
                    winner: wd ? wd.winner : null, winningLine: wd ? wd.line : null, status: wd ? 'finished' : 'playing'
                });
            } else {
                makeMove(index); if (gameActive && gameMode === 'pve' && currentPlayer === 'O') setTimeout(aiMove, 600);
            }
        }

        function makeMove(index) {
            board[index] = currentPlayer; const cell = boardElement.children[index];
            cell.innerText = currentPlayer; cell.classList.add(currentPlayer === 'X' ? 'x-mark' : 'o-mark');
            const wd = checkWinCondition(board, gridSize);
            if (wd) {
                if (wd.winner !== 'draw') { drawWinningLine(wd.line); scores[currentPlayer]++; playSFX('win'); } else { scores.draw++; playSFX('draw'); }
                updateScoreBoard(); setTimeout(() => showModal(wd.winner === 'draw' ? "HASIL SERI" : `PEMAIN ${currentPlayer} MENANG`, "Permainan selesai."), 300);
                gameActive = false;
            } else { currentPlayer = currentPlayer === 'X' ? 'O' : 'X'; updateTurnUI(); }
        }

        window.changeDifficulty = (l) => {
            initAudio(); playSFX('click'); aiDifficulty = l;
            ['easy', 'medium', 'hard'].forEach(v => {
                const b = document.getElementById('diff' + v.charAt(0).toUpperCase() + v.slice(1));
                const colors = { easy: 'bg-[#1e8e3e]', medium: 'bg-[#f9ab00]', hard: 'bg-[#d93025]' };
                b.className = (v === l) ? `px-3 py-1.5 rounded-full text-[10px] font-bold ${colors[v]} text-white transition-all uppercase shadow-sm` : "px-3 py-1.5 rounded-full text-[10px] font-bold bg-[#ffffff] text-[#444746] border border-[#e0e0e0] transition-all uppercase shadow-sm";
            });
            resetGame();
        };

        function aiMove() {
            if (!gameActive) return; let move = null;
            if (aiDifficulty === 'easy') move = getRandomMove();
            else if (aiDifficulty === 'medium') move = getWinningMove('O') || getWinningMove('X') || getRandomMove();
            else move = getWinningMove('O') || getWinningMove('X') || getStrategicMove() || getRandomMove();
            if (move !== null) { playSFX('click'); makeMove(move); }
        }

        function getRandomMove() { const m = board.map((v, i) => v === '' ? i : null).filter(v => v !== null); return m.length > 0 ? m[Math.floor(Math.random() * m.length)] : null; }
        function getWinningMove(p) { for (let i = 0; i < board.length; i++) { if (board[i] === '') { const tb = [...board]; tb[i] = p; const res = checkWinCondition(tb, gridSize); if (res && res.winner === p) return i; } } return null; }
        function getStrategicMove() { const c = Math.floor(board.length / 2); if (board[c] === '') return c; const s = gridSize, corners = [0, s - 1, s * (s - 1), s * s - 1], f = corners.filter(i => board[i] === ''); return f.length > 0 ? f[Math.floor(Math.random() * f.length)] : null; }

        function updateTurnUI() {
            currentPlayerText.innerText = `PEMAIN ${currentPlayer}`;
            document.getElementById('turnPulse').className = `w-2 h-2 rounded-full animate-pulse ${currentPlayer === 'X' ? 'bg-[#d93025]' : 'bg-[#1a73e8]'}`;
            document.getElementById('boxX').style.borderColor = currentPlayer === 'X' ? '#d93025' : 'transparent';
            document.getElementById('boxO').style.borderColor = currentPlayer === 'O' ? '#1a73e8' : 'transparent';
        }

        function updateScoreBoard() { scoreXElement.innerText = scores.X; scoreOElement.innerText = scores.O; scoreDrawElement.innerText = scores.draw; }
        function showModal(msg, submsg) { winnerText.innerText = msg; document.getElementById('winnerSubtext').innerText = submsg; statusModal.classList.remove('hidden'); statusModal.classList.add('flex'); setTimeout(() => document.getElementById('modalContent').classList.replace('scale-90', 'scale-100'), 10); }

        window.closeModal = () => { statusModal.classList.add('hidden'); statusModal.classList.remove('flex'); document.getElementById('modalContent').classList.replace('scale-100', 'scale-90'); };

        window.handlePlayAgain = async () => {
            playSFX('click'); closeModal();
            if (gameMode === 'online' && currentRoomId) {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId), { board: Array(gridSize * gridSize).fill(''), currentPlayer: 'X', winner: null, winningLine: null, status: 'playing' });
            } else { resetGame(); }
        };

        window.resetGame = () => { board = Array(gridSize * gridSize).fill(''); currentPlayer = 'X'; gameActive = true; updateTurnUI(); initBoard(); };
        window.resetScores = () => { scores = { X: 0, O: 0, draw: 0 }; updateScoreBoard(); resetGame(); };

        window.createNewRoom = async () => {
            initAudio(); playSFX('click'); startBGM(); if (!userId) return;
            const rid = Math.random().toString(36).substring(2, 8).toUpperCase(); currentRoomId = rid; mySymbol = 'X';
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', rid), { board: Array(gridSize * gridSize).fill(''), gridSize: gridSize, currentPlayer: 'X', players: { X: userId, O: null }, status: 'waiting', winner: null, winningLine: null, scores: { X: 0, O: 0, draw: 0 } });
            gridSelectorContainer.classList.add('hidden'); startRoomListener(rid);
        };

        window.joinRoom = async () => {
            initAudio(); playSFX('click'); startBGM(); const inputId = document.getElementById('roomInput').value.trim().toUpperCase();
            if (!inputId || !userId) return;
            const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', inputId));
            if (!snap.exists()) return alert("Room tidak ditemukan!");
            const data = snap.data(); if (data.players.O && data.players.O !== userId) return alert("Room penuh!");
            if (!data.players.O && data.players.X !== userId) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', inputId), { "players.O": userId, status: 'playing' });
            currentRoomId = inputId; mySymbol = data.players.X === userId ? 'X' : 'O'; gridSelectorContainer.classList.add('hidden'); startRoomListener(inputId);
        };

        function startRoomListener(rid) {
            onlineLobby.classList.add('hidden'); boardElement.parentElement.parentElement.classList.remove('hidden');
            document.getElementById('turnStatus').classList.remove('hidden'); onlineRoomBadge.classList.remove('hidden');
            document.getElementById('displayRoomId').innerText = rid;
            
            // Player Room Listener
            unsubscribeRoom = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', rid), (snap) => {
                if (!snap.exists()) { setMode('pvp'); return; }
                const data = snap.data(); board = data.board; gridSize = data.gridSize; currentPlayer = data.currentPlayer;
                gameActive = data.status !== 'finished'; scores = data.scores || scores;
                document.getElementById('labelX').innerText = data.players.X === userId ? "ANDA (X)" : "LAWAN (X)";
                document.getElementById('labelO').innerText = data.players.O ? (data.players.O === userId ? "ANDA (O)" : "LAWAN (O)") : "MENUNGGU...";
                updateScoreBoard(); initBoard(); updateTurnUI();
                if (data.status === 'finished') { if (data.winner && data.winner !== 'draw') { drawWinningLine(data.winningLine); playSFX('win'); } else playSFX('draw'); showModal(data.winner === 'draw' ? "HASIL SERI" : (data.winner === mySymbol ? "ANDA MENANG!" : "ANDA KALAH!"), "Permainan Online selesai."); }
                else if (data.status === 'playing') { closeModal(); }
            });

            // Chat Listener
            const chatCollection = collection(db, 'artifacts', appId, 'public', 'data', 'rooms', rid, 'messages');
            unsubscribeChat = onSnapshot(chatCollection, (snap) => {
                const messages = [];
                snap.forEach(d => messages.push(d.data()));
                messages.sort((a,b) => a.timestamp - b.timestamp);
                renderChat(messages);
                const panel = document.getElementById('chatPanel');
                if (!panel.classList.contains('open') && messages.length > 0) {
                    document.getElementById('chatDot').classList.remove('hidden');
                }
            });
        }

        function renderChat(msgs) {
            const container = document.getElementById('chatMessages');
            container.innerHTML = '';
            msgs.forEach(m => {
                const bubble = document.createElement('div');
                bubble.className = `chat-bubble ${m.senderId === userId ? 'chat-me' : 'chat-them'}`;
                bubble.innerText = m.text;
                container.appendChild(bubble);
            });
            container.scrollTop = container.scrollHeight;
        }

        window.sendChatMessage = async () => {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text || !currentRoomId) return;
            input.value = '';
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId, 'messages'), {
                text: text,
                senderId: userId,
                timestamp: Date.now()
            });
        };

        window.toggleChat = () => {
            const panel = document.getElementById('chatPanel');
            const isOpen = panel.classList.toggle('open');
            if (isOpen) document.getElementById('chatDot').classList.add('hidden');
            playSFX('click');
        };

        window.copyRoomId = () => { playSFX('click'); const t = document.getElementById('displayRoomId').innerText, el = document.createElement('textarea'); el.value = t; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); const toast = document.getElementById('toast'); toast.style.opacity = '1'; setTimeout(() => toast.style.opacity = '0', 2000); };
        window.onload = () => { initBoard(); updateTurnUI(); updateScoreBoard(); };
        window.addEventListener('click', () => { if (!audioCtx) { initAudio(); startBGM(); } }, { once: true });

        // Enter to send chat
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChatMessage();
        });
    </script>
</body>
</html>

