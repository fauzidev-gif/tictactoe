<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tic Tac Toe Pro Ultra - Verified HD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap');
        
        /* Proteksi Global */
        html, body {
            overflow: hidden;
            overscroll-behavior: none;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            touch-action: none;
            height: 100%;
            width: 100%;
            position: fixed;
            background-color: #ffffff;
        }

        input {
            user-select: text !important;
            -webkit-user-select: text !important;
            touch-action: auto !important;
        }

        body {
            font-family: 'Poppins', sans-serif;
            color: #1f1f1f;
        }

        /* Layout */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100dvh;
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
            padding: 1.25rem;
            position: relative;
        }

        /* Google Material 3 Style */
        .google-card {
            background-color: #ffffff;
            border-radius: 28px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid #f1f3f4;
        }

        .mode-tabs {
            background-color: #f1f3f4;
            border-radius: 100px;
            padding: 6px;
            display: flex;
            gap: 4px;
        }

        .mode-tab {
            padding: 10px 16px;
            border-radius: 100px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex: 1;
            text-align: center;
            color: #444746;
        }

        .mode-tab.active {
            background-color: #ffffff;
            color: #1a73e8;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* Profile Tabs */
        .profile-tabs {
            display: flex;
            border-bottom: 1px solid #f1f3f4;
            margin-bottom: 20px;
        }

        .profile-tab-btn {
            flex: 1;
            padding: 12px 0;
            font-size: 10px;
            font-weight: 800;
            color: #5f6368;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            transition: all 0.3s;
        }

        .profile-tab-btn.active {
            color: #1a73e8;
        }

        .profile-tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 20%;
            right: 20%;
            height: 3px;
            background: #1a73e8;
            border-radius: 100px 100px 0 0;
        }

        .board-container {
            background-color: #f1f3f4;
            border-radius: 36px;
            padding: 12px;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.04);
            border: 1px solid #e0e0e0;
        }

        .cell {
            aspect-ratio: 1 / 1;
            background-color: #ffffff;
            border-radius: 22px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10;
            border: 1px solid #f1f3f4;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        }

        .cell:active { transform: scale(0.92); background-color: #f8f9fa; }

        .x-mark { color: #d93025; filter: drop-shadow(0 2px 6px rgba(217, 48, 37, 0.2)); }
        .o-mark { color: #1a73e8; filter: drop-shadow(0 2px 6px rgba(26, 115, 232, 0.2)); }

        #winLineOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 30;
            padding: 12px;
        }

        #winLine {
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: drawLine 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            stroke-linecap: round;
            stroke-width: 7;
        }

        @keyframes drawLine { to { stroke-dashoffset: 0; } }

        .mute-btn {
            background-color: #ffffff;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            color: #444746;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.06);
        }

        .mute-btn:active { transform: scale(0.9); }

        #board.grid-3 { grid-template-columns: repeat(3, 1fr); }
        #board.grid-4 { grid-template-columns: repeat(4, 1fr); }
        #board.grid-5 { grid-template-columns: repeat(5, 1fr); }

        .watermark {
            text-align: center;
            font-size: 10px;
            font-weight: 700;
            color: #bdc1c6;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-top: 1rem;
            opacity: 0.8;
        }

        /* CHAT STYLES */
        #chatPanel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            z-index: 100;
            border-radius: 32px 32px 0 0;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.15);
            max-height: 80dvh;
        }
        #chatPanel.open { transform: translateY(0); }
        .chat-bubble {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 18px;
            margin-bottom: 8px;
            font-size: 13px;
            line-height: 1.4;
            word-wrap: break-word;
            position: relative;
        }
        .chat-me { background: #1a73e8; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .chat-them { background: #f1f3f4; color: #1f1f1f; align-self: flex-start; border-bottom-left-radius: 4px; }
        .chat-sender { font-size: 9px; font-weight: 700; margin-bottom: 2px; text-transform: uppercase; opacity: 0.7; display: flex; align-items: center; gap: 4px; }

        /* AVATAR STYLES */
        .avatar-img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        .avatar-option {
            width: 58px;
            height: 58px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            background: #f1f3f4;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .avatar-option.selected {
            border-color: #1a73e8;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
        }
        .score-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid #e0e0e0;
        }
        .svg-icon {
            width: 24px;
            height: 24px;
            color: #5f6368;
        }

        /* VERIFIED BADGE HD */
        .verified-badge {
            width: 16px;
            height: 16px;
            display: inline-flex;
            margin-left: 4px;
            vertical-align: middle;
            filter: drop-shadow(0 1px 1px rgba(0,0,0,0.1));
            flex-shrink: 0;
        }

        /* SEARCHING PULSE */
        .pulse-searching {
            animation: pulse-ring 1.5s cubic-bezier(0.24, 0, 0.38, 1) infinite;
        }
        @keyframes pulse-ring {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(26, 115, 232, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(26, 115, 232, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(26, 115, 232, 0); }
        }

        /* ADMIN BADGE STYLE */
        .admin-btn {
            background: linear-gradient(135deg, #1f1f1f, #3c4043);
            color: #fb8c00;
            border: 1px solid #5f6368;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .admin-badge {
            background: #1f1f1f;
            color: #fb8c00;
            font-size: 8px;
            font-weight: 900;
            padding: 1px 5px;
            border-radius: 4px;
            margin-left: 4px;
            border: 1px solid #fb8c00;
            display: inline-block;
            vertical-align: middle;
            line-height: 1;
        }

        /* STATS STYLE */
        .stats-item {
            flex: 1;
            padding: 12px 5px;
            border-radius: 20px;
            background: #f8f9fa;
            border: 1px solid #f1f3f4;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: transform 0.2s;
        }
        .stats-item:active { transform: scale(0.95); }

        /* ACHIEVEMENTS STYLE */
        .achievement-card {
            background: #f8f9fa;
            border: 1px solid #f1f3f4;
            border-radius: 20px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        .achievement-card.unlocked {
            background: #ffffff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.04);
            border-color: #e8f0fe;
        }
        .achievement-badge-v2 {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            background: #f1f3f4;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            color: #bdc1c6;
            transition: all 0.4s;
        }
        .achievement-card.unlocked .achievement-badge-v2 {
            background: #e8f0fe;
            color: #1a73e8;
            box-shadow: 0 4px 10px rgba(26, 115, 232, 0.2);
        }

        /* PING INDICATOR */
        .ping-box {
            font-size: 8px;
            font-weight: 800;
            padding: 2px 8px;
            border-radius: 100px;
            background: #f1f3f4;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .ping-dot { width: 5px; height: 5px; border-radius: 50%; }
        .ping-good { background: #1e8e3e; color: #1e8e3e; }
        .ping-med { background: #f9ab00; color: #f9ab00; }
        .ping-bad { background: #d93025; color: #d93025; }

    </style>
</head>
<body>

    <div class="app-container">
        <!-- HEADER -->
        <div class="header-content text-center mb-6 shrink-0">
            <div class="flex items-center justify-between mb-4">
                <div class="flex gap-2">
                    <button onclick="openProfileModal()" class="w-10 h-10 rounded-full border border-[#e0e0e0] overflow-hidden shadow-sm active:scale-90 transition-all bg-[#f1f3f4] flex items-center justify-center" title="Profil">
                        <img src="" id="headerAvatar" class="avatar-img hidden">
                        <div id="headerAvatarFallback" class="svg-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        </div>
                    </button>
                    <!-- ADMIN ACCESS BUTTON -->
                    <button id="adminTrigger" onclick="openAdminPanel()" class="w-10 h-10 rounded-full admin-btn hidden items-center justify-center active:scale-90 transition-all" title="Admin Access">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12,1L3,5v6c0,5.55,3.84,10.74,9,12c5.16-1.26,9-6.45,9-12V5L12,1z M12,7c1.38,0,2.5,1.12,2.5,2.5c0,0.72-0.31,1.38-0.81,1.84 L15,15h-2v-1.5c0-0.28-0.22-0.5-0.5-0.5s-0.5,0.22-0.5,0.5V15H10v-1.5c0-0.28-0.22-0.5-0.5-0.5S9,13.22,9,13.5V15H7l1.31-3.66 C7.81,10.88,7.5,10.22,7.5,9.5C7.5,8.12,8.62,7,10,7L12,7z"/></svg>
                    </button>
                </div>

                <h1 class="text-xl font-bold tracking-tight text-[#1f1f1f]">Tic Tac <span class="text-blue-600">Toe</span> Pro</h1>
                
                <button onclick="openLeaderboard()" class="w-10 h-10 rounded-full border border-[#e0e0e0] flex items-center justify-center shadow-sm active:scale-90 transition-all bg-[#ffffff] text-[#f9ab00]" title="Peringkat">
                    <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M19,5h-2V3H7v2H5C3.9,5,3,5.9,3,7v1c0,2.55,1.92,4.63,4.39,4.94c0.63,1.5,1.98,2.63,3.61,2.96V19H7v2h10v-2h-4v-3.1 c1.63-0.33,2.98-1.46,3.61-2.96C19.08,12.63,21,10.55,21,8V7C21,5.9,20.1,5,19,5z M5,8V7h2v3.82C5.84,10.4,5,9.3,5,8z M19,8 c0,1.3-0.84,2.4-2,2.82V7h2V8z"/></svg>
                </button>
            </div>
            
            <div id="onlineRoomBadge" class="hidden mb-4">
                <div class="flex items-center justify-center gap-2">
                    <div class="inline-flex items-center gap-2 bg-[#e8f0fe] text-[#1a73e8] px-5 py-2 rounded-full border border-[#aecbfa] shadow-sm">
                        <span class="text-[10px] font-bold uppercase tracking-widest opacity-70">Room ID:</span>
                        <span id="displayRoomId" class="font-mono font-bold tracking-wider">------</span>
                        <button onclick="copyRoomId()" class="ml-1 p-1.5 rounded-full transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                        </button>
                    </div>
                    <button onclick="toggleChat()" class="relative bg-white p-2.5 rounded-full border border-gray-200 shadow-sm active:scale-90 transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                        </svg>
                        <span id="chatDot" class="absolute top-1 right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white hidden"></span>
                    </button>
                </div>
            </div>

            <!-- SCORE BOARD -->
            <div class="flex items-center gap-3">
                <div class="google-card p-3 flex-1 flex flex-col items-center transition-all border-b-4 border-transparent overflow-hidden" id="boxX">
                    <div class="flex items-center gap-1.5 mb-1">
                        <div id="scoreAvatarXContainer" class="w-5 h-5 rounded-full bg-gray-100 overflow-hidden flex items-center justify-center">
                            <img src="" id="avatarX" class="score-avatar hidden">
                            <svg id="fallbackX" class="w-3 h-3 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        </div>
                        <span class="text-[9px] font-bold text-[#5f6368] uppercase tracking-tighter truncate max-w-[80px] flex items-center gap-0.5" id="labelX">Pemain X</span>
                    </div>
                    <span id="scoreX" class="text-2xl font-bold text-[#d93025]">0</span>
                </div>
                <div class="google-card p-2 px-4 shrink-0 flex flex-col items-center bg-[#f1f3f4] border border-[#e0e0e0] shadow-none">
                    <span class="text-[9px] font-bold text-[#5f6368] uppercase">Draw</span>
                    <span id="scoreDraw" class="text-xl font-bold text-[#1f1f1f]">0</span>
                </div>
                <div class="google-card p-3 flex-1 flex flex-col items-center transition-all border-b-4 border-transparent overflow-hidden" id="boxO">
                    <div class="flex items-center gap-1.5 mb-1">
                        <div id="scoreAvatarOContainer" class="w-5 h-5 rounded-full bg-gray-100 overflow-hidden flex items-center justify-center">
                            <img src="" id="avatarO" class="score-avatar hidden">
                            <svg id="fallbackO" class="w-3 h-3 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        </div>
                        <span class="text-[9px] font-bold text-[#5f6368] uppercase tracking-tighter truncate max-w-[60px] flex items-center gap-0.5" id="labelO">Pemain O</span>
                    </div>
                    <span id="scoreO" class="text-2xl font-bold text-[#1a73e8]">0</span>
                </div>
            </div>
        </div>

        <div class="main-content flex flex-col overflow-y-auto">
            <!-- SETTINGS -->
            <div id="gameSettings" class="flex flex-col gap-4 mb-6 px-1">
                <div id="gridSelectorContainer" class="flex items-center justify-between">
                    <span class="text-[10px] font-bold text-[#5f6368] uppercase tracking-widest">Pilih Grid</span>
                    <div class="flex gap-2">
                        <button onclick="changeGrid(3)" id="grid3" class="px-4 py-1.5 rounded-full text-[10px] font-bold bg-[#1a73e8] text-white shadow-sm transition-all">3x3</button>
                        <button onclick="changeGrid(4)" id="grid4" class="px-4 py-1.5 rounded-full text-[10px] font-bold bg-[#ffffff] text-[#444746] border border-[#e0e0e0] shadow-sm transition-all">4x4</button>
                        <button onclick="changeGrid(5)" id="grid5" class="px-4 py-1.5 rounded-full text-[10px] font-bold bg-[#ffffff] text-[#444746] border border-[#e0e0e0] shadow-sm transition-all">5x5</button>
                    </div>
                </div>

                <div id="aiLevelContainer" class="flex items-center justify-between hidden">
                    <span class="text-[10px] font-bold text-[#5f6368] uppercase tracking-widest">Level AI</span>
                    <div class="flex gap-2">
                        <button onclick="changeDifficulty('easy')" id="diffEasy" class="px-3 py-1.5 rounded-full text-[10px] font-bold bg-[#1e8e3e] text-white transition-all uppercase shadow-sm">Easy</button>
                        <button onclick="changeDifficulty('medium')" id="diffMedium" class="px-3 py-1.5 rounded-full text-[10px] font-bold bg-[#ffffff] text-[#444746] border border-[#e0e0e0] transition-all uppercase shadow-sm">Med</button>
                        <button onclick="changeDifficulty('hard')" id="diffHard" class="px-3 py-1.5 rounded-full text-[10px] font-bold bg-[#ffffff] text-[#444746] border border-[#e0e0e0] transition-all uppercase shadow-sm">Hard</button>
                    </div>
                </div>
            </div>

            <!-- MODE TABS -->
            <div class="mode-tabs mb-6">
                <button onclick="setMode('pvp')" id="btnPvp" class="mode-tab active">Teman</button>
                <button onclick="setMode('pve')" id="btnPve" class="mode-tab">Bot AI</button>
                <button onclick="setMode('online')" id="btnOnline" class="mode-tab">Online</button>
            </div>

            <!-- LOBBY -->
            <div id="onlineLobby" class="hidden google-card p-6 mb-6 text-center">
                <h3 class="text-sm font-bold mb-4 text-[#1a73e8] tracking-wide uppercase">Multiplayer Online</h3>
                
                <button id="btnGlobalMatch" onclick="startGlobalMatchmaking()" class="w-full bg-[#1a73e8] text-white font-black py-4 rounded-2xl shadow-lg transition-all active:scale-95 mb-4 flex items-center justify-center gap-3">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10,10-4.48,10-10S17.52,2,12,2Zm-1,17.93c-3.95-.49-7-3.85-7-7.93,0-.62,.08-1.21,.21-1.79l4.79,4.79v1h2v1.93Zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55,0,1-.45,1-1V7h2c1.1,0,2-.9,2-2v-.41c2.93,1.19,5,4.06,5,7.41,0,2.08-.8,3.97-2.1,5.39Z"/></svg>
                    CARI LAWAN GLOBAL
                </button>

                <div class="flex items-center gap-3 px-2 mb-4">
                    <div class="h-[1px] bg-[#e0e0e0] flex-1"></div>
                    <span class="text-[10px] font-bold text-[#5f6368] uppercase">Main via Kode</span>
                    <div class="h-[1px] bg-[#e0e0e0] flex-1"></div>
                </div>

                <div class="space-y-4">
                    <button onclick="createNewRoom()" class="w-full bg-[#ffffff] border-2 border-[#1a73e8] text-[#1a73e8] font-bold py-3 rounded-2xl shadow-sm transition-all active:scale-95">
                        Buat Room Baru
                    </button>
                    <div class="flex gap-2">
                        <input type="text" id="roomInput" placeholder="Kode Room" class="flex-1 bg-[#f1f3f4] border border-transparent rounded-2xl px-4 py-3 text-[#1f1f1f] font-bold uppercase text-center outline-none focus:bg-white focus:border-[#1a73e8] text-xs tracking-widest transition-all">
                        <button onclick="joinRoom()" class="bg-[#1f1f1f] hover:bg-[#000000] text-white font-bold px-6 rounded-2xl transition-all text-xs">Join</button>
                    </div>
                </div>
                
                <div class="mt-4 flex flex-col items-center gap-2">
                    <p id="connectionStatus" class="text-[9px] text-[#5f6368] font-black uppercase tracking-widest">Server: Menghubungkan...</p>
                    <div id="pingIndicator" class="ping-box hidden">
                        <div id="pingDot" class="ping-dot ping-good"></div>
                        <span id="pingValue">-- ms</span>
                    </div>
                </div>
            </div>

            <!-- SEARCHING OVERLAY -->
            <div id="searchingOverlay" class="hidden google-card p-8 mb-6 text-center flex flex-col items-center justify-center py-12">
                <div class="w-20 h-20 bg-blue-50 rounded-full flex items-center justify-center mb-6 pulse-searching">
                    <svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                </div>
                <h3 class="text-lg font-black text-gray-800 uppercase tracking-tight mb-1">Mencari Lawan...</h3>
                <p class="text-[10px] text-gray-500 font-bold uppercase tracking-widest mb-8">Mohon tunggu sebentar</p>
                <button onclick="cancelMatchmaking()" class="px-8 py-3 rounded-full border border-gray-200 text-gray-600 text-xs font-bold uppercase tracking-widest active:scale-90 transition-all">Batal</button>
            </div>

            <!-- BOARD CONTAINER -->
            <div class="relative mb-6">
                <div class="board-container shadow-xl">
                    <div id="board" class="grid gap-2 relative">
                        <!-- Cells -->
                    </div>
                </div>
                <svg id="winLineOverlay" viewBox="0 0 100 100" preserveAspectRatio="none">
                    <line id="winLine" x1="0" x2="0" stroke="white" class="hidden" />
                </svg>
            </div>

            <!-- TURN INDICATOR & CONTROLS -->
            <div id="statusControlArea" class="mb-8 flex items-center justify-center gap-3">
                <div id="turnStatus" class="inline-flex items-center gap-2 bg-[#ffffff] px-6 py-3 rounded-full border border-[#e0e0e0] shadow-sm">
                    <div class="w-2 h-2 rounded-full animate-pulse bg-[#d93025]" id="turnPulse"></div>
                    <span class="text-[11px] font-bold text-[#1f1f1f] tracking-widest flex items-center gap-1 uppercase" id="currentPlayerText">PEMAIN X</span>
                </div>

                <button onclick="toggleMute()" class="mute-btn shrink-0" id="muteBtn">
                    <svg id="svg-speaker" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                    </svg>
                </button>

                <button onclick="requestReset()" class="bg-[#1f1f1f] text-white p-3 rounded-full shadow-lg active:scale-90 transition-all flex items-center justify-center" title="Ulangi Game">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                </button>
            </div>

            <!-- BOTTOM CONTROLS -->
            <div class="mt-auto flex items-center justify-center gap-4 px-2">
                <a href="https://teer.id/fauzidev" target="_blank" class="flex-1 max-w-[220px] inline-flex items-center justify-center gap-2 bg-[#fce8e6] text-[#d93025] font-bold py-2.5 px-5 rounded-full transition-all active:scale-95 shadow-sm border border-[#f5c2c7]">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                    </svg>
                    <span class="text-[10px] uppercase tracking-widest font-extrabold">Support Dev</span>
                </a>
            </div>

            <!-- WATERMARK -->
            <div class="watermark mb-4">BY FAUZI DEV</div>
        </div>

        <!-- ADMIN PANEL MODAL -->
        <div id="adminPanelModal" class="fixed inset-0 bg-[#202124]/60 backdrop-blur-md hidden items-center justify-center z-[80] p-4">
            <div class="google-card p-6 w-full max-w-sm text-center scale-90 transition-transform duration-300 shadow-2xl flex flex-col max-h-[85dvh]" id="adminPanelContent">
                <div class="flex items-center justify-between mb-6 shrink-0">
                    <div class="flex items-center gap-2">
                        <div class="text-[#fb8c00]">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12,1L3,5v6c0,5.55,3.84,10.74,9,12c5.16-1.26,9-6.45,9-12V5L12,1z"/></svg>
                        </div>
                        <h2 class="text-xl font-black text-[#1f1f1f] uppercase tracking-tighter">Panel Akses Penuh</h2>
                    </div>
                    <button onclick="closeAdminPanel()" class="p-1 text-gray-400"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
                </div>

                <div class="flex-1 overflow-y-auto pr-1" id="adminPlayerList">
                    <div class="py-10 text-gray-400 text-xs uppercase font-bold tracking-widest loading-dots">Memuat Pemain...</div>
                </div>

                <div class="mt-4 pt-4 border-t shrink-0">
                    <p class="text-[9px] text-[#fb8c00] font-black uppercase tracking-widest">Hanya untuk FAUZIDEV Verified</p>
                </div>
            </div>
        </div>

        <!-- WIN MODAL -->
        <div id="statusModal" class="fixed inset-0 bg-[#202124]/40 backdrop-blur-sm hidden items-center justify-center z-50 p-6">
            <div class="google-card p-10 w-full max-w-xs text-center scale-90 transition-transform duration-300 shadow-2xl" id="modalContent">
                <div class="w-16 h-16 bg-[#e8f0fe] rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-[#1a73e8]" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                </div>
                <h2 id="winnerText" class="text-2xl font-extrabold mb-2 text-[#1f1f1f] uppercase">X MENANG!</h2>
                <p id="winnerSubtext" class="text-xs text-[#5f6368] mb-8 font-medium">Permainan selesai.</p>
                <button onclick="handlePlayAgain()" class="w-full bg-[#1a73e8] hover:bg-[#174ea6] text-white font-bold py-4 rounded-2xl shadow-xl transition-all active:scale-95 text-sm uppercase tracking-widest">
                    Main Lagi
                </button>
            </div>
        </div>

        <!-- PROFILE MODAL (REFINED TAB SYSTEM) -->
        <div id="profileModal" class="fixed inset-0 bg-[#202124]/40 backdrop-blur-sm hidden items-center justify-center z-50 p-6">
            <div class="google-card w-full max-w-xs text-center scale-90 transition-transform duration-300 shadow-2xl overflow-hidden flex flex-col max-h-[90dvh]" id="profileModalContent">
                
                <div class="p-6 pb-0 shrink-0">
                    <h2 class="text-xl font-black mb-4 text-[#1f1f1f] uppercase">Profil Saya</h2>
                    
                    <!-- Tab Selector -->
                    <div class="profile-tabs">
                        <button onclick="switchProfileTab('account')" id="tabBtnAccount" class="profile-tab-btn active">Akun</button>
                        <button onclick="switchProfileTab('stats')" id="tabBtnStats" class="profile-tab-btn">Statistik</button>
                        <button onclick="switchProfileTab('achievements')" id="tabBtnAchievements" class="profile-tab-btn">Pencapaian</button>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto p-6 pt-0">
                    <!-- Tab: Account -->
                    <div id="profileTabAccount" class="profile-section block">
                        <div class="mb-6 text-left">
                            <label class="block text-[10px] font-bold text-[#5f6368] uppercase mb-2">Nama Tampilan</label>
                            <input type="text" id="profileNameInput" maxlength="12" placeholder="Nama Anda" class="w-full bg-[#f1f3f4] border border-transparent rounded-2xl px-4 py-3 text-[#1f1f1f] font-bold outline-none focus:bg-white focus:border-[#1a73e8] transition-all">
                        </div>
                        <div class="mb-4 text-left">
                            <label class="block text-[10px] font-bold text-[#5f6368] uppercase mb-3">Pilih Foto Profil</label>
                            <div class="grid grid-cols-4 gap-3" id="avatarSelector"></div>
                        </div>
                    </div>

                    <!-- Tab: Stats -->
                    <div id="profileTabStats" class="profile-section hidden">
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div class="stats-item">
                                <span id="statWin" class="text-xl font-black text-green-600">0</span>
                                <span class="text-[8px] font-bold text-gray-400 uppercase">Menang</span>
                            </div>
                            <div class="stats-item">
                                <span id="statLoss" class="text-xl font-black text-red-600">0</span>
                                <span class="text-[8px] font-bold text-gray-400 uppercase">Kalah</span>
                            </div>
                            <div class="stats-item">
                                <span id="statDraw" class="text-xl font-black text-gray-600">0</span>
                                <span class="text-[8px] font-bold text-gray-400 uppercase">Seri</span>
                            </div>
                            <div class="stats-item">
                                <span id="statPlayed" class="text-xl font-black text-blue-600">0</span>
                                <span class="text-[8px] font-bold text-gray-400 uppercase">Main</span>
                            </div>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100 text-left">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-[9px] font-bold text-blue-700 uppercase">Win Rate</span>
                                <span id="winRateVal" class="text-[9px] font-black text-blue-800">0%</span>
                            </div>
                            <div class="w-full bg-blue-200 h-2 rounded-full overflow-hidden">
                                <div id="winRateBar" class="bg-blue-600 h-full transition-all duration-1000" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Achievements -->
                    <div id="profileTabAchievements" class="profile-section hidden">
                        <div id="achievementsList" class="space-y-3">
                            <!-- Achievement cards will be injected here -->
                        </div>
                    </div>
                </div>

                <div class="p-6 pt-0 shrink-0 flex flex-col gap-3">
                    <button onclick="saveProfile()" class="w-full bg-[#1a73e8] text-white font-bold py-4 rounded-2xl shadow-lg transition-all active:scale-95 text-xs uppercase tracking-widest">SIMPAN PERUBAHAN</button>
                    <button onclick="closeProfileModal()" class="w-full bg-white border border-gray-200 text-[#5f6368] font-bold py-4 rounded-2xl transition-all active:scale-95 text-xs uppercase tracking-widest">BATAL</button>
                </div>
            </div>
        </div>

        <!-- LEADERBOARD MODAL -->
        <div id="leaderboardModal" class="fixed inset-0 bg-[#202124]/40 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
            <div class="google-card p-6 w-full max-w-sm text-center scale-90 transition-transform duration-300 shadow-2xl flex flex-col max-h-[80dvh]" id="leaderboardModalContent">
                <div class="flex items-center justify-between mb-6 shrink-0">
                    <div class="flex items-center gap-2">
                        <div class="text-[#f9ab00]">
                            <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M19,5h-2V3H7v2H5C3.9,5,3,5.9,3,7v1c0,2.55,1.92,4.63,4.39,4.94c0.63,1.5,1.98,2.63,3.61,2.96V19H7v2h10v-2h-4v-3.1 c1.63-0.33,2.98-1.46,3.61-2.96C19.08,12.63,21,10.55,21,8V7C21,5.9,20.1,5,19,5z M5,8V7h2v3.82C5.84,10.4,5,9.3,5,8z M19,8 c0,1.3-0.84,2.4-2,2.82V7h2V8z"/></svg>
                        </div>
                        <h2 class="text-xl font-extrabold text-[#1f1f1f] uppercase tracking-tighter">Papan Peringkat</h2>
                    </div>
                    <button onclick="closeLeaderboard()" class="p-1 text-gray-400"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
                </div>

                <div class="flex-1 overflow-y-auto pr-1" id="leaderboardList">
                    <div class="py-10 text-gray-400 text-xs uppercase font-bold tracking-widest loading-dots">Memuat</div>
                </div>

                <div class="mt-4 pt-4 border-t shrink-0">
                    <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Hanya kemenangan Online yang dihitung</p>
                </div>
            </div>
        </div>

        <!-- ERROR / NOTIFICATION MODAL -->
        <div id="alertModal" class="fixed inset-0 bg-[#202124]/40 backdrop-blur-sm hidden items-center justify-center z-[70] p-6">
            <div class="google-card p-8 w-full max-w-xs text-center scale-90 transition-transform duration-300 shadow-2xl" id="alertModalContent">
                <div class="w-16 h-16 bg-[#e8f0fe] rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg id="alertIcon" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-[#1a73e8]" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </div>
                <h2 id="alertTitle" class="text-lg font-extrabold mb-2 text-[#1f1f1f] uppercase">INFO</h2>
                <p id="alertMessage" class="text-xs text-[#5f6368] mb-8 font-medium">Pesan kustom di sini.</p>
                <button onclick="closeAlertModal()" class="w-full bg-[#1a73e8] text-white font-bold py-4 rounded-2xl shadow-lg transition-all active:scale-95 text-xs uppercase tracking-widest">MENGERTI</button>
            </div>
        </div>

        <!-- RESET MODAL -->
        <div id="resetConfirmModal" class="fixed inset-0 bg-[#202124]/40 backdrop-blur-sm hidden items-center justify-center z-50 p-6">
            <div class="google-card p-8 w-full max-w-xs text-center scale-90 transition-transform duration-300 shadow-2xl" id="resetModalContent">
                <div class="w-16 h-16 bg-[#fce8e6] rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-[#d93025]" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                </div>
                <h2 class="text-xl font-extrabold mb-2 text-[#1f1f1f] uppercase">ULANGI GAME?</h2>
                <p class="text-xs text-[#5f6368] mb-8 font-medium">Papan akan dikosongkan. Tindakan ini tidak dapat dibatalkan.</p>
                <div class="flex flex-col gap-3">
                    <button onclick="confirmReset()" class="w-full bg-[#d93025] text-white font-bold py-4 rounded-2xl shadow-lg transition-all active:scale-95 text-xs uppercase tracking-widest">YA, ULANGI</button>
                    <button onclick="closeResetModal()" class="w-full bg-white border border-gray-200 text-[#5f6368] font-bold py-4 rounded-2xl transition-all active:scale-95 text-xs uppercase tracking-widest">BATAL</button>
                </div>
            </div>
        </div>

        <!-- CHAT PANEL -->
        <div id="chatPanel">
            <div class="flex items-center justify-between p-5 border-b shrink-0">
                <span class="font-bold text-sm text-gray-700 tracking-tight uppercase">Obrolan Room</span>
                <button onclick="toggleChat()" class="p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="chatMessages" class="flex-1 overflow-y-auto p-5 flex flex-col bg-[#fafafa]"></div>
            <div class="p-4 border-t shrink-0 flex gap-2 items-center bg-white pb-10">
                <input type="text" id="chatInput" placeholder="Ketik pesan..." class="flex-1 bg-[#f1f3f4] rounded-2xl px-4 py-3 text-sm outline-none focus:bg-white focus:border-[#1a73e8] border border-transparent transition-all">
                <button onclick="sendChatMessage()" class="bg-[#1a73e8] text-white p-3 rounded-full shadow-md active:scale-90 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
                </button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-[#1f1f1f] text-white px-6 py-2.5 rounded-full font-bold shadow-2xl opacity-0 transition-opacity pointer-events-none z-[60] text-[10px] tracking-widest uppercase">Kode Disalin!</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, deleteDoc, collection, addDoc, increment, query, where, getDocs, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- SVGs ---
        const BLUE_CHECK = `<svg class="verified-badge" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L13.8 4.3L16.6 3.9L17.5 6.6L20.2 7.5L19.8 10.3L22.1 12.1L19.8 13.9L20.2 16.7L17.5 17.6L16.6 20.3L13.8 19.9L12 22.2L10.2 19.9L7.4 20.3L6.5 17.6L3.8 16.7L4.2 13.9L1.9 12.1L4.2 10.3L3.8 7.5L6.5 6.6L7.4 3.9L10.2 4.3L12 2Z" fill="#0095F6"/><path d="M16.5 9.5L10.5 15.5L7.5 12.5" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
        
        const ACHIEV_ICONS = {
            trophy: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M19 5h-2V3H7v2H5c-1.1 0-2 .9-2 2v1c0 2.55 1.92 4.63 4.39 4.94.63 1.5 1.98 2.63 3.61 2.96V19H7v2h10v-2h-4v-3.1c1.63-.33 2.98-1.46 3.61-2.96C19.08 12.63 21 10.55 21 8V7c0-1.1-.9-2-2-2zM5 8V7h2v3.82C5.84 10.4 5 9.3 5 8zm14 0c0 1.3-.84 2.4-2 2.82V7h2v1z"/></svg>`,
            medal: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M12 11c1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3 1.34 3 3 3zm0-8c2.76 0 5 2.24 5 5s-2.24 5-5 5-5-2.24-5-5 2.24-5 5-5zm0 13c-2.33 0-4.32 1.45-5.12 3.5H5.06C6.03 16.51 8.8 14.5 12 14.5s5.97 2.01 6.94 5h-1.82c-.8-2.05-2.79-3.5-5.12-3.5z"/></svg>`,
            crown: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M5 16L3 5l5 5 4-7 4 7 5-5-2 11H5zm14 3c0 .55-.45 1-1 1H6c-.55 0-1-.45-1-1v-1h14v1z"/></svg>`,
            shield: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/></svg>`,
            lightning: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M7 2v11h3v9l7-12h-4l4-8z"/></svg>`
        };

        // --- AUDIO ---
        let audioCtx = null, isMuted = false;
        const initAudio = () => { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (audioCtx.state === 'suspended') audioCtx.resume(); };
        const playSFX = (type) => {
            if (isMuted || !audioCtx) return; const osc = audioCtx.createOscillator(), gain = audioCtx.createGain(); osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            if (type === 'click') { osc.type = 'sine'; osc.frequency.setValueAtTime(400, now); gain.gain.setValueAtTime(0.2, now); osc.start(); osc.stop(now + 0.1); }
            else if (type === 'win') { osc.type = 'triangle'; [523, 659, 783].forEach((f, i) => osc.frequency.setValueAtTime(f, now + i * 0.1)); gain.gain.setValueAtTime(0.2, now); osc.start(); osc.stop(now + 0.4); }
            else if (type === 'draw') { osc.type = 'sine'; osc.frequency.setValueAtTime(200, now); gain.gain.setValueAtTime(0.2, now); osc.start(); osc.stop(now + 0.3); }
        };

        window.toggleMute = () => {
            isMuted = !isMuted; const svg = document.getElementById('svg-speaker');
            if (isMuted) svg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />';
            else { initAudio(); svg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />'; }
        };

        // --- ACHIEVEMENTS LIST ---
        const ACHIEVEMENTS = [
            { id: 'first_win', title: 'Pemenang Pertama', icon: 'trophy', desc: 'Menangkan 1 game Online', goal: 1, type: 'totalWins' },
            { id: 'pakar_ttc', title: 'Pakar Tic Tac Toe', icon: 'medal', desc: 'Menangkan 10 game Online', goal: 10, type: 'totalWins' },
            { id: 'legend_hidup', title: 'Legenda Hidup', icon: 'crown', desc: 'Menangkan 50 game Online', goal: 50, type: 'totalWins' },
            { id: 'penjaga_seri', title: 'Sang Penjaga', icon: 'shield', desc: 'Dapatkan 10 kali hasil Seri', goal: 10, type: 'totalDraws' },
            { id: 'pemain_aktif', title: 'Pemain Aktif', icon: 'lightning', desc: 'Mainkan total 100 ronde', goal: 100, type: 'totalPlayed' }
        ];

        // --- GAME STATE ---
        let gridSize = 3, board = Array(9).fill(''), currentPlayer = 'X', gameActive = true, gameMode = 'pvp', aiDifficulty = 'easy', scores = { X: 0, O: 0, draw: 0 };
        let db, auth, userId, currentRoomId = null, mySymbol = null, unsubscribeRoom = null, unsubscribeChat = null;
        let onlineWinCounted = false; 
        
        const avatarOptions = [
            null,
            'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=120&h=120&fit=crop',
            'https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=120&h=120&fit=crop',
            'https://images.unsplash.com/photo-1599566150163-29194dcaad36?w=120&h=120&fit=crop',
            'https://images.unsplash.com/photo-1580489944761-15a19d654956?w=120&h=120&fit=crop',
            'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=120&h=120&fit=crop',
            'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=120&h=120&fit=crop',
            'https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=120&h=120&fit=crop',
            'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=120&h=120&fit=crop'
        ];
        
        let userProfile = { name: 'Pemain', avatar: null, totalWins: 0, totalLosses: 0, totalDraws: 0, totalPlayed: 0, unlockedAchievements: [] };
        let selectedAvatarUrl = null;

        const firebaseConfig = {
            apiKey: "AIzaSyAiknTiGhLeeZREUy5CJQ6Gq8O0FSXWYh8",
            authDomain: "tictactoe-ultra.firebaseapp.com",
            projectId: "tictactoe-ultra",
            storageBucket: "tictactoe-ultra.firebasestorage.app",
            messagingSenderId: "110161757179",
            appId: "1:110161757179:web:b3aaf10a123a77728d815e"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'tictactoe-pro-v6-verified';
        const app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app);

        const boardElement = document.getElementById('board'), scoreXElement = document.getElementById('scoreX'), scoreOElement = document.getElementById('scoreO'), scoreDrawElement = document.getElementById('scoreDraw');
        const currentPlayerText = document.getElementById('currentPlayerText'), statusModal = document.getElementById('statusModal'), winnerText = document.getElementById('winnerText'), onlineLobby = document.getElementById('onlineLobby');
        const onlineRoomBadge = document.getElementById('onlineRoomBadge'), gridSelectorContainer = document.getElementById('gridSelectorContainer'), winLine = document.getElementById('winLine'), aiLevelContainer = document.getElementById('aiLevelContainer');

        async function initAuth() { if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token); else await signInAnonymously(auth); }
        onAuthStateChanged(auth, async (user) => { 
            if (user) { 
                userId = user.uid; 
                const s = document.getElementById('connectionStatus'); 
                if (s) s.innerText = "Server: Online (" + userId.substring(0,4) + ")"; 
                await loadUserProfile(); 
                checkBanStatus(); 
                startPingMonitor();
            } 
        });
        initAuth();

        // --- PING MONITOR ---
        async function startPingMonitor() {
            const pingVal = document.getElementById('pingValue');
            const pingDot = document.getElementById('pingDot');
            const pingBox = document.getElementById('pingIndicator');

            setInterval(async () => {
                if (gameMode !== 'online') { pingBox.classList.add('hidden'); return; }
                pingBox.classList.remove('hidden');
                
                const start = Date.now();
                try {
                    await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ping_check', 'heartbeat'));
                    const latency = Date.now() - start;
                    pingVal.innerText = latency + ' ms';
                    pingDot.className = 'ping-dot ' + (latency < 150 ? 'ping-good' : latency < 400 ? 'ping-med' : 'ping-bad');
                } catch (e) { pingVal.innerText = 'Err'; }
            }, 10000);
        }

        // --- ADMIN HELPERS ---
        async function checkBanStatus() {
            if (!userId) return;
            const banRef = doc(db, 'artifacts', appId, 'public', 'data', 'banned', userId);
            const snap = await getDoc(banRef);
            if (snap.exists()) {
                document.body.innerHTML = `
                <div class="h-screen w-full flex flex-col items-center justify-center p-10 bg-black text-white text-center">
                    <div class="w-24 h-24 mb-6 text-red-600">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12,2L1,21H23L12,2M12,6L19.53,19H4.47L12,6M11,10V14H13V10H11M11,16V18H13V16H11Z"/></svg>
                    </div>
                    <h1 class="text-3xl font-black mb-4">AKSES DIBLOKIR</h1>
                    <p class="text-gray-400 font-bold uppercase tracking-widest text-sm">Akun Anda telah di-banned oleh FAUZIDEV karena pelanggaran kebijakan.</p>
                </div>`;
            }
        }

        // --- UTILS ---
        function formatName(name, showBadge = false) {
            const isFauzi = name.toUpperCase() === 'FAUZIDEV';
            let res = name;
            if (isFauzi) {
                res += BLUE_CHECK;
                if (showBadge) res += '<span class="admin-badge">ADMIN</span>';
            }
            return res;
        }

        window.showErrorModal = (title, message) => {
            document.getElementById('alertTitle').innerText = title;
            document.getElementById('alertMessage').innerText = message;
            const modal = document.getElementById('alertModal');
            modal.classList.replace('hidden', 'flex');
            setTimeout(() => document.getElementById('alertModalContent').classList.replace('scale-90', 'scale-100'), 10);
        };
        window.closeAlertModal = () => {
            document.getElementById('alertModalContent').classList.replace('scale-100', 'scale-90');
            setTimeout(() => document.getElementById('alertModal').classList.replace('flex', 'hidden'), 200);
        };

        // --- PROFILE TABS LOGIC ---
        window.switchProfileTab = (tab) => {
            playSFX('click');
            const sections = document.querySelectorAll('.profile-section');
            const btns = document.querySelectorAll('.profile-tab-btn');
            
            sections.forEach(s => s.classList.add('hidden'));
            btns.forEach(b => b.classList.remove('active'));
            
            if (tab === 'account') {
                document.getElementById('profileTabAccount').classList.remove('hidden');
                document.getElementById('tabBtnAccount').classList.add('active');
            } else if (tab === 'stats') {
                document.getElementById('profileTabStats').classList.remove('hidden');
                document.getElementById('tabBtnStats').classList.add('active');
                updateStatsTab();
            } else if (tab === 'achievements') {
                document.getElementById('profileTabAchievements').classList.remove('hidden');
                document.getElementById('tabBtnAchievements').classList.add('active');
                renderAchievements();
            }
        };

        function updateStatsTab() {
            const wins = userProfile.totalWins || 0;
            const played = userProfile.totalPlayed || 0;
            const rate = played > 0 ? Math.round((wins / played) * 100) : 0;
            
            document.getElementById('statWin').innerText = wins;
            document.getElementById('statLoss').innerText = userProfile.totalLosses || 0;
            document.getElementById('statDraw').innerText = userProfile.totalDraws || 0;
            document.getElementById('statPlayed').innerText = played;
            
            document.getElementById('winRateVal').innerText = rate + '%';
            document.getElementById('winRateBar').style.width = rate + '%';
        }

        // --- PROFILE SYNC ---
        async function loadUserProfile() {
            if (!userId) return;
            const profileRef = doc(db, 'artifacts', appId, 'users', userId, 'profile', 'data');
            const snap = await getDoc(profileRef);
            if (snap.exists()) { 
                userProfile = { ...userProfile, ...snap.data() }; 
                selectedAvatarUrl = userProfile.avatar; 
            } 
            else { 
                userProfile = { name: 'Player' + Math.floor(1000 + Math.random() * 9000), avatar: null, totalWins: 0, totalLosses: 0, totalDraws: 0, totalPlayed: 0, unlockedAchievements: [] }; 
                await setDoc(profileRef, userProfile); 
            }
            updateProfileUI();
            updateLeaderboardEntry();
            
            if (userProfile.name.toUpperCase() === 'FAUZIDEV') {
                document.getElementById('adminTrigger').classList.replace('hidden', 'flex');
            }
        }

        function updateProfileUI() {
            const hImg = document.getElementById('headerAvatar');
            const hFallback = document.getElementById('headerAvatarFallback');
            if (userProfile.avatar) { hImg.src = userProfile.avatar; hImg.classList.remove('hidden'); hFallback.classList.add('hidden'); } 
            else { hImg.classList.add('hidden'); hFallback.classList.remove('hidden'); }
            document.getElementById('profileNameInput').value = userProfile.name;
            
            if (gameMode !== 'online') {
                document.getElementById('labelX').innerHTML = formatName(userProfile.name, false);
                updateAvatarDisplay('X', userProfile.avatar);
                document.getElementById('labelO').innerText = (gameMode === 'pve' ? 'BOT AI' : 'TEMAN');
                updateAvatarDisplay('O', gameMode === 'pve' ? 'https://ui-avatars.com/api/?name=BOT&background=000&color=fff' : null);
            }
        }

        function renderAchievements() {
            const container = document.getElementById('achievementsList');
            container.innerHTML = '';
            ACHIEVEMENTS.forEach(ach => {
                const isUnlocked = userProfile.unlockedAchievements?.includes(ach.id);
                const card = document.createElement('div');
                card.className = `achievement-card ${isUnlocked ? 'unlocked' : ''}`;
                
                const progress = ach.type === 'totalWins' ? userProfile.totalWins : ach.type === 'totalDraws' ? userProfile.totalDraws : userProfile.totalPlayed;
                const perc = Math.min(100, Math.round((progress / ach.goal) * 100));

                card.innerHTML = `
                    <div class="achievement-badge-v2">
                        ${ACHIEV_ICONS[ach.icon]}
                    </div>
                    <div class="flex-1 text-left">
                        <div class="flex justify-between items-center mb-0.5">
                            <span class="text-[11px] font-black ${isUnlocked ? 'text-[#1a73e8]' : 'text-[#5f6368]'} uppercase">${ach.title}</span>
                            ${isUnlocked ? '<span class="text-[8px] bg-green-100 text-green-700 px-1.5 rounded uppercase font-bold">Done</span>' : `<span class="text-[8px] text-gray-400 font-bold">${progress}/${ach.goal}</span>`}
                        </div>
                        <p class="text-[8px] text-gray-400 font-medium mb-2">${ach.desc}</p>
                        ${!isUnlocked ? `
                        <div class="w-full bg-[#f1f3f4] h-1 rounded-full overflow-hidden">
                            <div class="bg-blue-400 h-full" style="width: ${perc}%"></div>
                        </div>` : ''}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function updateLeaderboardEntry() {
            const lbRef = doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', userId);
            await setDoc(lbRef, { name: userProfile.name, avatar: userProfile.avatar, totalWins: userProfile.totalWins || 0 }, { merge: true });
        }

        function updateAvatarDisplay(side, url) {
            const img = document.getElementById(`avatar${side}`);
            const fb = document.getElementById(`fallback${side}`);
            if (url) { img.src = url; img.classList.remove('hidden'); fb.classList.add('hidden'); } 
            else { img.classList.add('hidden'); fb.classList.remove('hidden'); }
        }

        function renderAvatarOptions() {
            const container = document.getElementById('avatarSelector'); container.innerHTML = '';
            avatarOptions.forEach(url => {
                const btn = document.createElement('div');
                btn.className = `avatar-option ${selectedAvatarUrl === url ? 'selected' : ''}`;
                if (url) btn.innerHTML = `<img src="${url}" class="avatar-img">`;
                else btn.innerHTML = `<svg class="w-6 h-6 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`;
                btn.onclick = () => { selectedAvatarUrl = url; renderAvatarOptions(); };
                container.appendChild(btn);
            });
        }

        window.openProfileModal = () => { playSFX('click'); document.getElementById('profileModal').classList.replace('hidden', 'flex'); setTimeout(() => document.getElementById('profileModalContent').classList.replace('scale-90', 'scale-100'), 10); renderAvatarOptions(); switchProfileTab('account'); };
        window.closeProfileModal = () => { playSFX('click'); document.getElementById('profileModalContent').classList.replace('scale-100', 'scale-90'); setTimeout(() => document.getElementById('profileModal').classList.replace('flex', 'hidden'), 200); };
        
        window.saveProfile = async () => {
            const newName = document.getElementById('profileNameInput').value.trim() || 'Pemain';
            const nameKey = newName.toLowerCase();
            const usernameRef = doc(db, 'artifacts', appId, 'public', 'data', 'usernames', nameKey);
            const nameSnap = await getDoc(usernameRef);
            if (nameSnap.exists() && nameSnap.data().uid !== userId) {
                showErrorModal("Gagal", `Nama "${newName}" sudah diklaim orang lain! Pilih nama lain.`);
                return;
            }
            await setDoc(usernameRef, { uid: userId });
            userProfile.name = newName; 
            userProfile.avatar = selectedAvatarUrl;
            updateProfileUI();
            closeProfileModal();
            await setDoc(doc(db, 'artifacts', appId, 'users', userId, 'profile', 'data'), userProfile);
            if (currentRoomId && mySymbol) { 
                const upd = {}; upd[`playerData.${mySymbol}`] = { name: newName, avatar: selectedAvatarUrl }; 
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId), upd); 
            }
            updateLeaderboardEntry();
            updateTurnUI();
            if (newName.toUpperCase() === 'FAUZIDEV') document.getElementById('adminTrigger').classList.replace('hidden', 'flex');
            else document.getElementById('adminTrigger').classList.replace('flex', 'hidden');
        };

        // --- ADMIN PANEL FUNCTIONS ---
        window.openAdminPanel = async () => {
            if (userProfile.name.toUpperCase() !== 'FAUZIDEV') return;
            playSFX('click');
            document.getElementById('adminPanelModal').classList.replace('hidden', 'flex');
            setTimeout(() => document.getElementById('adminPanelContent').classList.replace('scale-90', 'scale-100'), 10);
            const lbCol = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
            onSnapshot(lbCol, (snap) => {
                const players = [];
                snap.forEach(d => players.push({ uid: d.id, ...d.data() }));
                players.sort((a,b) => b.totalWins - a.totalWins);
                renderAdminPlayerList(players);
            });
        };

        window.closeAdminPanel = () => {
            playSFX('click');
            document.getElementById('adminPanelContent').classList.replace('scale-100', 'scale-90');
            setTimeout(() => document.getElementById('adminPanelModal').classList.replace('flex', 'hidden'), 200);
        };

        async function renderAdminPlayerList(players) {
            const list = document.getElementById('adminPlayerList');
            list.innerHTML = '';
            const bannedSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'banned'));
            const bannedUids = bannedSnap.docs.map(d => d.id);
            players.forEach((p) => {
                if (p.uid === userId) return; 
                const isBanned = bannedUids.includes(p.uid);
                const item = document.createElement('div');
                item.className = `p-4 mb-3 rounded-2xl bg-[#f8f9fa] border border-gray-100 flex flex-col gap-3`;
                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full overflow-hidden bg-white border border-gray-200">
                            ${p.avatar ? `<img src="${p.avatar}" class="avatar-img">` : `<svg class="w-10 h-10 text-gray-300" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="12"/></svg>`}
                        </div>
                        <div class="flex-1 text-left">
                            <div class="text-[11px] font-black text-[#1f1f1f] flex items-center gap-1">
                                ${p.name} ${isBanned ? '<span class="text-[7px] bg-red-600 text-white px-1.5 rounded uppercase">Banned</span>' : ''}
                            </div>
                            <div class="text-[9px] text-gray-500 font-bold">UID: ${p.uid.substring(0,8)}... | Win: ${p.totalWins}</div>
                        </div>
                    </div>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="adminAdjustScore('${p.uid}', 1)" class="flex-1 bg-green-100 text-green-700 text-[8px] font-bold py-2 rounded-xl border border-green-200">+ SKOR</button>
                        <button onclick="adminAdjustScore('${p.uid}', -1)" class="flex-1 bg-orange-100 text-orange-700 text-[8px] font-bold py-2 rounded-xl border border-orange-200">- SKOR</button>
                        ${isBanned 
                            ? `<button onclick="adminRequestUnban('${p.uid}')" class="flex-1 bg-blue-600 text-white text-[8px] font-bold py-2 rounded-xl">UNBAN</button>`
                            : `<button onclick="adminRequestBan('${p.uid}')" class="flex-1 bg-red-600 text-white text-[8px] font-bold py-2 rounded-xl">BAN</button>`
                        }
                    </div>
                `;
                list.appendChild(item);
            });
        }

        window.adminAdjustScore = async (targetUid, amount) => {
            const playerRefPublic = doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', targetUid);
            const playerRefPrivate = doc(db, 'artifacts', appId, 'users', targetUid, 'profile', 'data');
            try {
                await updateDoc(playerRefPublic, { totalWins: increment(amount) });
                await updateDoc(playerRefPrivate, { totalWins: increment(amount) }).catch(() => {});
            } catch(e) { console.error(e); }
        };

        // --- LEADERBOARD ---
        window.openLeaderboard = () => {
            playSFX('click');
            document.getElementById('leaderboardModal').classList.replace('hidden', 'flex');
            setTimeout(() => document.getElementById('leaderboardModalContent').classList.replace('scale-90', 'scale-100'), 10);
            const lbCol = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
            onSnapshot(lbCol, (snap) => {
                const players = [];
                snap.forEach(d => players.push({ id: d.id, ...d.data() }));
                players.sort((a,b) => b.totalWins - a.totalWins);
                renderLeaderboard(players);
            }, (err) => console.error("Leaderboard fail:", err));
        };

        function renderLeaderboard(players) {
            const list = document.getElementById('leaderboardList');
            list.innerHTML = '';
            players.forEach((p, idx) => {
                const item = document.createElement('div');
                item.className = `flex items-center gap-3 p-3 mb-2 rounded-2xl ${p.id === userId ? 'bg-blue-50 border border-blue-100' : 'bg-[#f8f9fa]'}`;
                const rankColor = idx === 0 ? 'text-[#f9ab00]' : idx === 1 ? 'text-[#9e9e9e]' : idx === 2 ? 'text-[#cd7f32]' : 'text-gray-400';
                item.innerHTML = `
                    <div class="w-6 text-xs font-black ${rankColor}">${idx + 1}</div>
                    <div class="w-10 h-10 rounded-full overflow-hidden bg-white border border-gray-200 flex items-center justify-center shrink-0">
                        ${p.avatar ? `<img src="${p.avatar}" class="avatar-img">` : `<svg class="w-5 h-5 text-gray-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`}
                    </div>
                    <div class="flex-1 text-left">
                        <div class="text-[12px] font-bold text-[#1f1f1f] truncate w-32 flex items-center">
                            ${formatName(p.name, true)} 
                            ${p.id === userId ? '<span class="text-[8px] text-blue-500 ml-1 font-black">(ANDA)</span>' : ''}
                        </div>
                        <div class="text-[9px] text-gray-400 font-bold uppercase tracking-tighter">${p.totalWins} Kemenangan</div>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        window.closeLeaderboard = () => {
            playSFX('click');
            document.getElementById('leaderboardModalContent').classList.replace('scale-100', 'scale-90');
            setTimeout(() => document.getElementById('leaderboardModal').classList.replace('flex', 'hidden'), 200);
        };

        // --- GAME CORE ---
        function checkWinCondition(cb, size) {
            const winLength = size === 3 ? 3 : 4; 
            for (let r = 0; r < size; r++) {
                for (let c = 0; c < size; c++) {
                    const p = cb[r * size + c]; if (!p) continue;
                    const checks = [[0,1], [1,0], [1,1], [1,-1]];
                    for (let [dr, dc] of checks) {
                        let win = true, line = [];
                        for (let k = 0; k < winLength; k++) {
                            const nr = r + k * dr, nc = c + k * dc;
                            if (nr < 0 || nr >= size || nc < 0 || nc >= size || cb[nr * size + nc] !== p) { win = false; break; }
                            line.push(nr * size + nc);
                        }
                        if (win) return { winner: p, line };
                    }
                }
            }
            return cb.includes('') ? null : { winner: 'draw', line: null };
        }

        function initBoard() {
            boardElement.innerHTML = ''; boardElement.className = `grid grid-${gridSize} gap-2 relative`;
            board.forEach((cell, index) => {
                const el = document.createElement('div'); el.classList.add('cell');
                if (gridSize === 3) el.classList.add('text-5xl', 'font-extrabold'); else if (gridSize === 4) el.classList.add('text-3xl', 'font-bold'); else el.classList.add('text-2xl', 'font-bold');
                el.dataset.index = index; el.addEventListener('click', handleCellClick);
                if (cell !== '') { el.innerText = cell; el.classList.add(cell === 'X' ? 'x-mark' : 'o-mark'); }
                boardElement.appendChild(el);
            });
            winLine.classList.add('hidden');
        }

        function drawWinningLine(li) {
            const s = gridSize, sIdx = li[0], eIdx = li[li.length - 1];
            const sc = sIdx % s, sr = Math.floor(sIdx / s), ec = eIdx % s, er = Math.floor(eIdx / s);
            const cs = 100 / s, os = cs / 2;
            winLine.setAttribute('x1', sc * cs + os); winLine.setAttribute('y1', sr * cs + os);
            winLine.setAttribute('x2', ec * cs + os); winLine.setAttribute('y2', er * cs + os);
            winLine.setAttribute('stroke', currentPlayer === 'X' ? '#d93025' : '#1a73e8');
            winLine.classList.remove('hidden'); winLine.style.animation = 'none'; winLine.offsetHeight; winLine.style.animation = null;
        }

        window.changeGrid = (size) => { initAudio(); playSFX('click'); if (currentRoomId) return; gridSize = size; board = Array(size * size).fill(''); [3,4,5].forEach(v => { const b = document.getElementById(`grid${v}`); b.className = (v === size) ? "px-4 py-1.5 rounded-full text-[10px] font-bold bg-[#1a73e8] text-white shadow-sm transition-all" : "px-4 py-1.5 rounded-full text-[10px] font-bold bg-[#ffffff] text-[#444746] border border-[#e0e0e0] shadow-sm transition-all"; }); resetGame(); };

        window.setMode = async (mode) => {
            initAudio(); playSFX('click');
            if (currentRoomId) { try { const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId); await deleteDoc(roomRef); } catch(e) {} }
            if (unsubscribeRoom) unsubscribeRoom(); if (unsubscribeChat) unsubscribeChat();
            resetScores(); gameMode = mode; currentRoomId = null; mySymbol = null;
            ['pvp', 'pve', 'online'].forEach(m => { const b = document.getElementById('btn' + m.charAt(0).toUpperCase() + m.slice(1)); b.className = (m === mode) ? "mode-tab active" : "mode-tab"; });
            aiLevelContainer.classList.toggle('hidden', mode !== 'pve'); onlineLobby.classList.toggle('hidden', mode !== 'online');
            document.getElementById('searchingOverlay').classList.add('hidden');
            boardElement.parentElement.parentElement.classList.toggle('hidden', mode === 'online'); document.getElementById('statusControlArea').classList.toggle('hidden', mode === 'online');
            onlineRoomBadge.classList.add('hidden'); gridSelectorContainer.classList.remove('hidden'); document.getElementById('chatPanel').classList.remove('open');
            updateProfileUI(); resetGame();
        };

        async function handleCellClick(e) {
            initAudio(); const index = parseInt(e.currentTarget.dataset.index);
            if (board[index] !== '' || !gameActive) return; playSFX('click');
            if (gameMode === 'online') {
                if (mySymbol !== currentPlayer || !currentRoomId) return;
                const nb = [...board]; nb[index] = mySymbol; const wd = checkWinCondition(nb, gridSize);
                let newScores = { ...scores }; if (wd) { if (wd.winner === 'X') newScores.X++; else if (wd.winner === 'O') newScores.O++; else if (wd.winner === 'draw') newScores.draw++; }
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId), { board: nb, currentPlayer: mySymbol === 'X' ? 'O' : 'X', winner: wd ? wd.winner : null, winningLine: wd ? wd.line : null, status: wd ? 'finished' : 'playing', scores: newScores });
            } else { makeMove(index); if (gameActive && gameMode === 'pve' && currentPlayer === 'O') setTimeout(aiMove, 600); }
        }

        // --- STATS LOGIC ---
        async function incrementGlobalStat(type) {
            if (!userId) return;
            const update = { totalPlayed: increment(1) };
            userProfile.totalPlayed = (userProfile.totalPlayed || 0) + 1;

            if (type === 'win') { update.totalWins = increment(1); userProfile.totalWins++; }
            if (type === 'loss') { update.totalLosses = increment(1); userProfile.totalLosses++; }
            if (type === 'draw') { update.totalDraws = increment(1); userProfile.totalDraws++; }
            
            await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'profile', 'data'), update);
            if (type === 'win') await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', userId), { totalWins: increment(1) });
            
            checkAchievements();
            updateProfileUI();
        }

        async function checkAchievements() {
            if (!userId) return;
            const newlyUnlocked = [];
            ACHIEVEMENTS.forEach(ach => {
                if (userProfile.unlockedAchievements?.includes(ach.id)) return;
                const currentVal = userProfile[ach.type] || 0;
                if (currentVal >= ach.goal) newlyUnlocked.push(ach.id);
            });

            if (newlyUnlocked.length > 0) {
                userProfile.unlockedAchievements = [...(userProfile.unlockedAchievements || []), ...newlyUnlocked];
                await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'profile', 'data'), { unlockedAchievements: userProfile.unlockedAchievements });
                const toast = document.getElementById('toast');
                toast.innerText = `UNLOCK: ${newlyUnlocked.length} PENCAPAIAN!`;
                toast.style.opacity = '1';
                setTimeout(() => toast.style.opacity = '0', 3000);
            }
        }

        function makeMove(index) {
            board[index] = currentPlayer; const cell = boardElement.children[index]; cell.innerText = currentPlayer; cell.classList.add(currentPlayer === 'X' ? 'x-mark' : 'o-mark');
            const wd = checkWinCondition(board, gridSize);
            if (wd) { 
                if (wd.winner !== 'draw') { 
                    drawWinningLine(wd.line); scores[currentPlayer]++; playSFX('win'); 
                    if (currentPlayer === 'X') incrementGlobalStat('win'); else incrementGlobalStat('loss');
                } else { 
                    scores.draw++; playSFX('draw'); 
                    incrementGlobalStat('draw');
                } 
                updateScoreBoard(); 
                setTimeout(() => showModal(wd.winner === 'draw' ? "HASIL SERI" : `PEMAIN ${currentPlayer} MENANG`, "Selesai."), 300); 
                gameActive = false; 
            } else { 
                currentPlayer = currentPlayer === 'X' ? 'O' : 'X'; updateTurnUI(); 
            }
        }

        window.changeDifficulty = (l) => { initAudio(); playSFX('click'); aiDifficulty = l; ['easy', 'medium', 'hard'].forEach(v => { const b = document.getElementById('diff' + v.charAt(0).toUpperCase() + v.slice(1)); const col = { easy: 'bg-[#1e8e3e]', medium: 'bg-[#f9ab00]', hard: 'bg-[#d93025]' }; b.className = (v === l) ? `px-3 py-1.5 rounded-full text-[10px] font-bold ${col[v]} text-white transition-all uppercase shadow-sm` : "px-3 py-1.5 rounded-full text-[10px] font-bold bg-[#ffffff] text-[#444746] border border-[#e0e0e0] transition-all uppercase shadow-sm"; }); resetGame(); };
        function aiMove() { if (!gameActive) return; let m = (aiDifficulty === 'easy') ? getRandomMove() : (getWinningMove('O') || getWinningMove('X') || (aiDifficulty === 'hard' ? getStrategicMove() : null) || getRandomMove()); if (m !== null) makeMove(m); }
        function getRandomMove() { const m = board.map((v, i) => v === '' ? i : null).filter(v => v !== null); return m.length > 0 ? m[Math.floor(Math.random() * m.length)] : null; }
        function getWinningMove(p) { for (let i = 0; i < board.length; i++) { if (board[i] === '') { const tb = [...board]; tb[i] = p; if (checkWinCondition(tb, gridSize)?.winner === p) return i; } } return null; }
        function getStrategicMove() { const c = Math.floor(board.length / 2); if (board[c] === '') return c; const corners = [0, gridSize-1, board.length-gridSize, board.length-1].filter(i => board[i] === ''); return corners.length > 0 ? corners[Math.floor(Math.random() * corners.length)] : null; }

        function updateTurnUI() { 
            let activeName = currentPlayer === 'X' ? formatName(document.getElementById('labelX').innerText, true) : formatName(document.getElementById('labelO').innerText, true); 
            currentPlayerText.innerHTML = activeName; 
            document.getElementById('turnPulse').className = `w-2 h-2 rounded-full animate-pulse ${currentPlayer === 'X' ? 'bg-[#d93025]' : 'bg-[#1a73e8]'}`; 
            document.getElementById('boxX').style.borderColor = currentPlayer === 'X' ? '#d93025' : 'transparent'; 
            document.getElementById('boxO').style.borderColor = currentPlayer === 'O' ? '#1a73e8' : 'transparent'; 
        }
        function updateScoreBoard() { scoreXElement.innerText = scores.X; scoreOElement.innerText = scores.O; scoreDrawElement.innerText = scores.draw; }
        function showModal(msg, submsg) { winnerText.innerText = msg; document.getElementById('winnerSubtext').innerText = submsg; statusModal.classList.replace('hidden', 'flex'); setTimeout(() => document.getElementById('modalContent').classList.replace('scale-90', 'scale-100'), 10); }
        window.closeModal = () => { document.getElementById('modalContent').classList.replace('scale-100', 'scale-90'); setTimeout(() => statusModal.classList.replace('flex', 'hidden'), 200); };
        window.handlePlayAgain = async () => { playSFX('click'); closeModal(); if (gameMode === 'online' && currentRoomId) { onlineWinCounted = false; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId), { board: Array(gridSize * gridSize).fill(''), currentPlayer: 'X', winner: null, winningLine: null, status: 'playing' }); } else resetGame(); };
        window.requestReset = () => { initAudio(); playSFX('click'); document.getElementById('resetConfirmModal').classList.replace('hidden', 'flex'); setTimeout(() => document.getElementById('resetModalContent').classList.replace('scale-90', 'scale-100'), 10); };
        window.closeResetModal = () => { document.getElementById('resetModalContent').classList.replace('scale-100', 'scale-90'); setTimeout(() => document.getElementById('resetConfirmModal').classList.replace('flex', 'hidden'), 200); };
        window.confirmReset = async () => { closeResetModal(); if (gameMode === 'online' && currentRoomId) { onlineWinCounted = false; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId), { board: Array(gridSize * gridSize).fill(''), currentPlayer: 'X', winner: null, winningLine: null, status: 'playing' }); } else resetGame(); };
        window.resetGame = () => { board = Array(gridSize * gridSize).fill(''); currentPlayer = 'X'; gameActive = true; onlineWinCounted = false; updateTurnUI(); initBoard(); };
        window.resetScores = () => { scores = { X: 0, O: 0, draw: 0 }; updateScoreBoard(); resetGame(); };

        // --- ONLINE ---
        window.createNewRoom = async () => {
            initAudio(); playSFX('click'); if (!userId) return;
            const rid = Math.random().toString(36).substring(2, 8).toUpperCase(); currentRoomId = rid; mySymbol = 'X';
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', rid), { board: Array(gridSize * gridSize).fill(''), gridSize, currentPlayer: 'X', players: { X: userId, O: null }, playerData: { X: { name: userProfile.name, avatar: userProfile.avatar }, O: null }, status: 'waiting', winner: null, winningLine: null, scores: { X: 0, O: 0, draw: 0 } });
            gridSelectorContainer.classList.add('hidden'); startRoomListener(rid);
        };

        window.joinRoom = async () => {
            initAudio(); playSFX('click'); const rid = document.getElementById('roomInput').value.trim().toUpperCase(); if (!rid || !userId) return;
            const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', rid)); 
            if (!snap.exists()) return showErrorModal("ERROR", "Room ID tidak ditemukan!");
            const data = snap.data(); if (data.players.O && data.players.O !== userId) return showErrorModal("PENUH", "Room ini sudah penuh!");
            if (!data.players.O && data.players.X !== userId) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', rid), { "players.O": userId, "playerData.O": { name: userProfile.name, avatar: userProfile.avatar }, status: 'playing' });
            currentRoomId = rid; mySymbol = data.players.X === userId ? 'X' : 'O'; gridSelectorContainer.classList.add('hidden'); startRoomListener(rid);
        };

        window.startGlobalMatchmaking = async () => {
            initAudio(); playSFX('click'); if (!userId) return;
            onlineLobby.classList.add('hidden'); document.getElementById('searchingOverlay').classList.remove('hidden');
            const qMatch = query(collection(db, 'artifacts', appId, 'public', 'data', 'rooms'), where('status', '==', 'waiting'), where('isGlobal', '==', true), limit(1));
            const qSnap = await getDocs(qMatch);
            if (!qSnap.empty) {
                const rDoc = qSnap.docs[0]; const rid = rDoc.id; const data = rDoc.data();
                if (data.players.X !== userId) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', rid), { "players.O": userId, "playerData.O": { name: userProfile.name, avatar: userProfile.avatar }, status: 'playing' });
                    currentRoomId = rid; mySymbol = 'O'; document.getElementById('searchingOverlay').classList.add('hidden'); startRoomListener(rid);
                } else { currentRoomId = rid; mySymbol = 'X'; startRoomListener(rid); }
            } else {
                const rid = "GLB-" + Math.random().toString(36).substring(2, 6).toUpperCase(); currentRoomId = rid; mySymbol = 'X';
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', rid), { board: Array(gridSize * gridSize).fill(''), gridSize, currentPlayer: 'X', players: { X: userId, O: null }, playerData: { X: { name: userProfile.name, avatar: userProfile.avatar }, O: null }, status: 'waiting', winner: null, winningLine: null, scores: { X: 0, O: 0, draw: 0 }, isGlobal: true });
                startRoomListener(rid);
            }
        };

        window.cancelMatchmaking = async () => { if (currentRoomId) { try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId)); } catch(e) {} } setMode('online'); };

        function startRoomListener(rid) {
            onlineLobby.classList.add('hidden'); document.getElementById('searchingOverlay').classList.add('hidden');
            boardElement.parentElement.parentElement.classList.remove('hidden'); document.getElementById('statusControlArea').classList.remove('hidden'); onlineRoomBadge.classList.remove('hidden');
            document.getElementById('displayRoomId').innerText = rid;
            unsubscribeRoom = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', rid), (snap) => {
                if (!snap.exists()) { if (currentRoomId) { currentRoomId = null; showErrorModal("BUBAR", "Lawan meninggalkan room."); setMode('online'); } return; }
                const data = snap.data(); if (data.isGlobal && data.status === 'waiting') { document.getElementById('searchingOverlay').classList.remove('hidden'); boardElement.parentElement.parentElement.classList.add('hidden'); document.getElementById('statusControlArea').classList.add('hidden'); } else { document.getElementById('searchingOverlay').classList.add('hidden'); boardElement.parentElement.parentElement.classList.remove('hidden'); document.getElementById('statusControlArea').classList.remove('hidden'); }
                board = data.board; gridSize = data.gridSize; currentPlayer = data.currentPlayer; gameActive = data.status !== 'finished'; if (data.scores) scores = data.scores;
                const pX = data.playerData.X || { name: 'X', avatar: null }; const pO = data.playerData.O || { name: 'Menunggu...', avatar: null };
                document.getElementById('labelX').innerHTML = formatName(pX.name, false); updateAvatarDisplay('X', pX.avatar);
                document.getElementById('labelO').innerHTML = formatName(pO.name, false); updateAvatarDisplay('O', pO.avatar);
                updateScoreBoard(); initBoard(); updateTurnUI();
                if (data.status === 'finished') {
                    if (data.winner && data.winner !== 'draw') { drawWinningLine(data.winningLine); playSFX('win'); } else playSFX('draw');
                    showModal(data.winner === 'draw' ? "HASIL SERI" : (data.winner === mySymbol ? "ANDA MENANG!" : "ANDA KALAH!"), "Selesai.");
                    if (!onlineWinCounted) {
                        onlineWinCounted = true;
                        if (data.winner === 'draw') incrementGlobalStat('draw');
                        else if (data.winner === mySymbol) incrementGlobalStat('win');
                        else incrementGlobalStat('loss');
                    }
                } else if (data.status === 'playing') closeModal();
            });
            unsubscribeChat = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'rooms', rid, 'messages'), (snap) => {
                const msgs = []; snap.forEach(d => msgs.push(d.data())); msgs.sort((a,b) => a.timestamp - b.timestamp); renderChat(msgs);
                if (!document.getElementById('chatPanel').classList.contains('open') && msgs.length > 0) document.getElementById('chatDot').classList.remove('hidden');
            });
        }

        function renderChat(msgs) {
            const container = document.getElementById('chatMessages'); container.innerHTML = '';
            msgs.forEach(m => {
                const isMe = m.senderId === userId; const bubble = document.createElement('div'); bubble.className = `chat-bubble ${isMe ? 'chat-me' : 'chat-them'}`;
                const sender = document.createElement('div'); sender.className = 'chat-sender'; 
                sender.innerHTML = formatName(m.senderName || 'User', true);
                const txt = document.createElement('div'); txt.innerText = m.text;
                if (!isMe) bubble.appendChild(sender); bubble.appendChild(txt); container.appendChild(bubble);
            });
            container.scrollTop = container.scrollHeight;
        }

        window.sendChatMessage = async () => {
            const input = document.getElementById('chatInput'); const text = input.value.trim(); if (!text || !currentRoomId) return; input.value = '';
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId, 'messages'), { text, senderId: userId, senderName: userProfile.name, timestamp: Date.now() });
        };
        window.toggleChat = () => { const panel = document.getElementById('chatPanel'); const isOpen = panel.classList.toggle('open'); if (isOpen) document.getElementById('chatDot').classList.add('hidden'); playSFX('click'); };
        window.copyRoomId = () => { playSFX('click'); const t = document.getElementById('displayRoomId').innerText, el = document.createElement('textarea'); el.value = t; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); const toast = document.getElementById('toast'); toast.style.opacity = '1'; setTimeout(() => toast.style.opacity = '0', 2000); };
        
        window.onload = () => { initBoard(); updateTurnUI(); updateScoreBoard(); };
        window.addEventListener('click', () => { if (!audioCtx) initAudio(); }, { once: true });
        document.getElementById('chatInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendChatMessage(); });
    </script>
</body>
</html>

